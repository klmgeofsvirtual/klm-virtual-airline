<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KLM Virtual Airline | Operations Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Leaflet Map CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <style>
        /* KLM Brand Colors */
        :root {
            --klm-blue: #00A1DE;
            --klm-dark: #0077A3;
            --klm-sky: #E5F6FF;
            --discord: #5865F2;
            --discord-dark: #4752C4;
        }
        .text-klm { color: var(--klm-blue); }
        .bg-klm { background-color: var(--klm-blue); }
        .bg-klm-dark { background-color: var(--klm-dark); }
        .hover-bg-klm:hover { background-color: var(--klm-dark); }
        .bg-discord { background-color: var(--discord); }
        .hover-bg-discord:hover { background-color: var(--discord-dark); }
        
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Nav Active State */
        .nav-link.active {
            color: var(--klm-blue);
            font-weight: 700;
        }
        .nav-link.active::after {
            content: '';
            display: block;
            width: 100%;
            height: 2px;
            background: var(--klm-blue);
            margin-top: 2px;
        }

        /* Epaulettes */
        .epaulette {
            background: #1e293b;
            width: 60px;
            height: 80px;
            border-radius: 4px 4px 20px 20px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding-bottom: 10px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }
        .stripe {
            width: 80%;
            height: 6px;
            background: #eab308;
            margin-top: 4px;
        }

        /* Map Styles */
        #fleet-map {
            width: 100%;
            height: 600px;
            background: #0f172a;
            z-index: 1;
        }

        /* Dispatch Board Styles */
        .fids-board {
            font-family: 'Courier New', Courier, monospace;
            background: #0f172a;
            border: 4px solid #334155;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        .fids-header {
            background: #1e293b;
            color: #94a3b8;
            font-weight: bold;
            padding: 10px;
            display: grid;
            grid-template-columns: 1.5fr 0.8fr 0.8fr 1.5fr 1fr 1fr;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 1px;
        }
        .fids-row {
            padding: 12px 10px;
            display: grid;
            grid-template-columns: 1.5fr 0.8fr 0.8fr 1.5fr 1fr 1fr;
            color: #e2e8f0;
            border-bottom: 1px solid #1e293b;
            font-size: 0.85rem;
            align-items: center;
            animation: flashText 0.5s ease;
        }
        .fids-row:last-child { border-bottom: none; }
        
        @keyframes flashText {
            0% { opacity: 0; background-color: #334155; }
            100% { opacity: 1; background-color: transparent; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex flex-col min-h-screen">

    <!-- ERROR BANNER (Hidden by default) -->
    <div id="db-error-banner" class="hidden bg-red-600 text-white px-4 py-3 text-center shadow-lg z-[100]">
        <div class="flex items-center justify-center gap-2">
            <i data-lucide="alert-triangle" class="w-5 h-5"></i>
            <span class="font-bold">DATABASE ERROR:</span>
            <span class="text-sm">Connection lost or database not found.</span>
            <a href="https://console.cloud.google.com/datastore/setup?project=klm-dispatch" target="_blank" class="underline font-bold hover:text-red-200 ml-2">Fix in Console</a>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="sticky top-0 z-50 bg-white/95 backdrop-blur-md shadow-sm border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20">
                <div class="flex items-center cursor-pointer" onclick="router('home')">
                    <img id="nav-logo" src="" alt="KLM Logo" class="h-8 md:h-10 mr-3">
                    <div class="hidden md:flex flex-col leading-tight border-l border-slate-300 pl-3 ml-2">
                        <span class="font-bold text-slate-900 text-sm tracking-wide">OPERATIONS</span>
                        <span class="text-xs text-slate-500 uppercase tracking-widest">Center</span>
                    </div>
                </div>

                <!-- Desktop Menu -->
                <div class="hidden md:flex items-center space-x-6 lg:space-x-8">
                    <button onclick="router('home')" class="nav-link text-slate-600 hover:text-klm transition-colors font-medium py-2">Ops Center</button>
                    <button onclick="router('news')" class="nav-link text-slate-600 hover:text-klm transition-colors font-medium py-2">News</button>
                    <button onclick="router('booking')" class="nav-link text-slate-600 hover:text-klm transition-colors font-medium py-2">Dispatch</button>
                    <button onclick="router('fleet')" class="nav-link text-slate-600 hover:text-klm transition-colors font-medium py-2">Fleet</button>
                    <button onclick="router('routes')" class="nav-link text-slate-600 hover:text-klm transition-colors font-medium py-2">Network</button>
                    <button onclick="router('livemap')" class="nav-link text-slate-600 hover:text-klm transition-colors font-medium py-2">Live Map</button>
                    <button onclick="router('sop')" class="nav-link text-slate-600 hover:text-klm transition-colors font-medium py-2">SOP</button>
                    <button onclick="router('partners')" class="nav-link text-slate-600 hover:text-klm transition-colors font-medium py-2">Partners</button>
                    <button onclick="router('community')" class="nav-link text-slate-600 hover:text-klm transition-colors font-medium py-2">Crew</button>
                    
                    <a href="https://discord.gg/Zj9BrrxU" target="_blank" class="bg-slate-900 text-white px-5 py-2 rounded font-bold hover:bg-slate-800 transition shadow flex items-center text-sm uppercase tracking-wide">
                        <i data-lucide="radio" class="w-4 h-4 mr-2"></i> Report In
                    </a>
                </div>

                <div class="md:hidden flex items-center">
                    <button onclick="toggleMobileMenu()" class="text-slate-600 hover:text-klm focus:outline-none p-2">
                        <i data-lucide="menu" class="h-7 w-7"></i>
                    </button>
                </div>
            </div>
        </div>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-slate-100 shadow-xl absolute w-full left-0 z-40">
            <div class="p-4 space-y-2">
                <button onclick="router('home'); toggleMobileMenu()" class="block w-full text-left px-4 py-3 rounded hover:bg-slate-50 font-bold text-slate-800">Ops Center</button>
                <button onclick="router('news'); toggleMobileMenu()" class="block w-full text-left px-4 py-3 rounded hover:bg-slate-50 font-medium text-slate-600">News</button>
                <button onclick="router('booking'); toggleMobileMenu()" class="block w-full text-left px-4 py-3 rounded hover:bg-slate-50 font-medium text-slate-600">Dispatch</button>
                <button onclick="router('fleet'); toggleMobileMenu()" class="block w-full text-left px-4 py-3 rounded hover:bg-slate-50 font-medium text-slate-600">Fleet</button>
                <button onclick="router('routes'); toggleMobileMenu()" class="block w-full text-left px-4 py-3 rounded hover:bg-slate-50 font-medium text-slate-600">Network</button>
                <button onclick="router('livemap'); toggleMobileMenu()" class="block w-full text-left px-4 py-3 rounded hover:bg-slate-50 font-medium text-slate-600">Live Map</button>
                <button onclick="router('sop'); toggleMobileMenu()" class="block w-full text-left px-4 py-3 rounded hover:bg-slate-50 font-medium text-slate-600">SOP</button>
                <button onclick="router('partners'); toggleMobileMenu()" class="block w-full text-left px-4 py-3 rounded hover:bg-slate-50 font-medium text-slate-600">Partners</button>
                <button onclick="router('community'); toggleMobileMenu()" class="block w-full text-left px-4 py-3 rounded hover:bg-slate-50 font-medium text-slate-600">Crew</button>
            </div>
        </div>
    </nav>

    <main id="app-content" class="flex-grow"></main>

    <footer class="bg-slate-900 text-slate-400 py-12 border-t border-slate-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8 border-b border-slate-800 pb-8">
                <div class="col-span-1 md:col-span-2">
                    <img id="footer-logo" src="" alt="KLM Logo" class="h-8 mb-4 brightness-0 invert opacity-80">
                    <p class="text-sm leading-relaxed max-w-sm text-slate-500">
                        A non-profit virtual aviation community. We are not affiliated with KLM Royal Dutch Airlines.
                        <br><br>
                        <strong>Operations Hub:</strong> Amsterdam Airport Schiphol (EHAM)
                    </p>
                </div>
                <div>
                    <h4 class="text-white font-bold mb-4 uppercase text-xs tracking-wider">Flight Operations</h4>
                    <ul class="space-y-2 text-sm">
                        <li><button onclick="router('sop')" class="hover:text-white transition">Standard Operating Procedures</button></li>
                        <li><button onclick="router('fleet')" class="hover:text-white transition">Fleet Manifest</button></li>
                        <li><button onclick="router('routes')" class="hover:text-white transition">Network Map</button></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-white font-bold mb-4 uppercase text-xs tracking-wider">Command Staff</h4>
                    <ul class="space-y-2 text-sm font-mono">
                        <li>mileflight <span class="text-xs text-slate-600">// CEO</span></li>
                        <li>JustFrost <span class="text-xs text-slate-600">// Temp CEO</span></li>
                        <li>Nihid9044 <span class="text-xs text-slate-600">// CMO</span></li>
                    </ul>
                </div>
            </div>
            <div class="text-center md:text-left text-xs text-slate-600">
                &copy; 2026 KLM Virtual Airline. "Flying the World, Virtually."
            </div>
        </div>
    </footer>

    <!-- Leaflet Script (Non-module) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- MAIN APP SCRIPT (MODULE) -->
    <script type="module">
        // Import Modern Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, orderBy, query, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

        // ==========================================
        //  FIREBASE CONFIGURATION
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBNM1Xc7a64GIlOiBiwJ5hE9Ci6EK1lxuo",
            authDomain: "klm-dispatch.firebaseapp.com",
            projectId: "klm-dispatch",
            storageBucket: "klm-dispatch.firebasestorage.app",
            messagingSenderId: "805612664938",
            appId: "1:805612664938:web:7a794aaaa0c184dcf6f213",
            measurementId: "G-6QQH3YVRKW"
        };

        // Initialize Firebase
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            const analytics = getAnalytics(app);
            console.log("Firebase initialized successfully (Modular SDK)");
        } catch (e) {
            console.error("Firebase Initialization Error:", e);
        }

        // --- GLOBAL CONSTANTS ---
        const siteImages = {
            logo: "https://upload.wikimedia.org/wikipedia/commons/c/c7/KLM_logo.svg",
            homeHero: "https://content.r9cdn.net/rimg/dimg/aa/3f/bf32fc29-al-KL-168342f6d92.jpg?width=1366&height=768&xhint=1075&yhint=770&crop=true"
        };
        
        // --- AUTHENTICATION STATE ---
        let discordUser = null; 

        // --- CHECK FOR DISCORD REDIRECT ---
        function checkDiscordAuth() {
            const fragment = new URLSearchParams(window.location.hash.slice(1));
            const accessToken = fragment.get('access_token');
            const tokenType = fragment.get('token_type');

            if (accessToken) {
                window.history.replaceState({}, document.title, window.location.pathname);
                fetch('https://discord.com/api/users/@me', {
                    headers: {
                        authorization: `${tokenType} ${accessToken}`,
                    },
                })
                .then(result => result.json())
                .then(response => {
                    localStorage.setItem('klm_discord_user', JSON.stringify(response));
                    discordUser = response;
                    if(document.getElementById('login-section')) {
                        initBookingPage(); 
                    }
                })
                .catch(console.error);
            } else {
                const stored = localStorage.getItem('klm_discord_user');
                if (stored) {
                    discordUser = JSON.parse(stored);
                }
            }
        }
        
        checkDiscordAuth();

        const fleetData = [
            { type: "Embraer 190", icao: "E190", role: "Cityhopper", desc: "Short-haul, high-frequency ops for training and local connectivity.", status: "Active", count: 21, img: "https://upload.wikimedia.org/wikipedia/commons/c/c6/Berlin_Brandenburg_Airport_KLM_Cityhopper_Embraer_E195-E2_PH-NXC_%28DSC02878%29.jpg" },
            { type: "Embraer 195-E2", icao: "E295", role: "Cityhopper", desc: "Modern regional efficiency. High frequency European connections.", status: "Active", count: 25, img: "https://img.static-kl.com/transform/53cea398-7cff-4e3f-a7b1-496d4552fb10/" },
            { type: "Boeing 737-700", icao: "B737", role: "Short Haul", desc: "Legacy workhorse. Being phased out for A320neo family.", status: "Phasing Out", count: 6, img: "https://upload.wikimedia.org/wikipedia/commons/thumb/3/34/KLM_Boeing_737-7K2_PH-BGT_MUC_2015_01.jpg/1280px-KLM_Boeing_737-7K2_PH-BGT_MUC_2015_01.jpg" },
            { type: "Boeing 737-800", icao: "B738", role: "Short Haul", desc: "Backbone of European operations. Gradual retirement scheduled.", status: "Phasing Out", count: 30, img: "https://upload.wikimedia.org/wikipedia/commons/1/18/KLM_Boeing_737-800_PH-BCD_%2826038861623%29.jpg" },
            { type: "Airbus A320neo", icao: "A20N", role: "Short Haul", desc: "Next-gen European core. Maximum efficiency and realism.", status: "On Order", count: 9, img: "https://image.parool.nl/211007987/width/2480/impressie-van-een-airbus-a320-neo-in-de-kleuren-van-klm" },
            { type: "Airbus A321neo", icao: "A21N", role: "Short Haul", desc: "High-capacity European routes. Primary replacement for B737.", status: "Active", count: 22, img: "https://img.static-kl.com/transform/8806738a-a661-4934-a177-95adef39307d/" },
            { type: "Airbus A330-200", icao: "A332", role: "Medium Haul", desc: "Intercontinental connector. Scheduled for retirement.", status: "Phasing Out", count: 6, img: "https://cdn.flightsim.to/images/27/inibuilds-a330-300-klm-fleet-pack-55321-1735741086-uIy_G.jpg?width=1400" },
            { type: "Boeing 777-300ER", icao: "B77W", role: "Long Haul", desc: "High-capacity global reach. Fleet size reducing.", status: "Active", count: 11, img: "https://www.aerotime.aero/images/klm_boeing_777-300er_orange_pride_livery.jpg" },
            { type: "Boeing 787-9", icao: "B789", role: "Long Haul", desc: "The future of our long-haul operations. Elite flagship.", status: "Active", count: 13, img: "https://content.presspage.com/uploads/162/1920_25508202-10155250600310773-6357422191407278812-n.jpg" },
            { type: "Boeing 787-10", icao: "B78X", role: "Long Haul", desc: "High-capacity Dreamliner for premium long-haul routes.", status: "Active", count: 14, img: "https://content.presspage.com/uploads/162/1920_paulridderhof30jun196473-465547.jpg?10000" },
        ];

        const routeData = {
            "Europe": [
                { city: "London Heathrow", code: "EGLL", out: "1001+", in: "1002+" }, { city: "Paris CDG", code: "LFPG", out: "1401+", in: "1402+" }, { city: "Berlin", code: "EDDB", out: "1775+", in: "1770+" }, { city: "Rome", code: "LIRF", out: "1601+", in: "1600+" }, { city: "Madrid", code: "LEMD", out: "1501+", in: "1500+" }, { city: "Vienna", code: "LOWW", out: "1901+", in: "1900+" }, { city: "Brussels", code: "EBBR", out: "1701+", in: "1700+" }, { city: "Zurich", code: "LSZH", out: "1917+", in: "1916+" }, { city: "Geneva", code: "LSGG", out: "1929+", in: "1928+" }, { city: "Stockholm", code: "ESSA", out: "1215+", in: "1216+" }, { city: "Copenhagen", code: "EKCH", out: "1267+", in: "1266+" }, { city: "Oslo", code: "ENGM", out: "1197+", in: "1196+" }, { city: "Helsinki", code: "EFHK", out: "1251+", in: "1248+" }, { city: "Porto", code: "LPPR", out: "1571+", in: "1570+" }, { city: "Lisbon", code: "LPPT", out: "1579+", in: "1580+" }, { city: "Kraków", code: "EPKK", out: "1323+", in: "1322+" }, { city: "Warsaw", code: "EPWA", out: "1313+", in: "1310+" }, { city: "Prague", code: "LKPR", out: "1351+", in: "1350+" }, { city: "Budapest", code: "LHBP", out: "1363+", in: "1362+" }, { city: "Bucharest", code: "LROP", out: "1373+", in: "1372+" }, { city: "Marseille", code: "LFML", out: "1465+", in: "1464+" }, { city: "Nice", code: "LFMN", out: "1475+", in: "1472+" }, { city: "Athens", code: "LGAV", out: "1955+", in: "1952+" }
            ],
            "North America": [
                 { city: "New York JFK", code: "KJFK", out: "641+", in: "642+" }, { city: "Atlanta", code: "KATL", out: "621+", in: "622+" }, { city: "Los Angeles", code: "KLAX", out: "601+", in: "602+" }, { city: "San Francisco", code: "KSFO", out: "605+", in: "606+" }, { city: "Chicago", code: "KORD", out: "611+", in: "612+" }, { city: "Washington", code: "KIAD", out: "651+", in: "652+" }, { city: "Boston", code: "KBOS", out: "617+", in: "618+" }, { city: "Houston", code: "KIAH", out: "661+", in: "662+" }, { city: "Toronto", code: "CYYZ", out: "691+", in: "692+" }, { city: "Montreal", code: "CYUL", out: "671+", in: "672+" }, { city: "Calgary", code: "CYYC", out: "677+", in: "678+" }, { city: "Vancouver", code: "CYVR", out: "681+", in: "682+" }, { city: "Mexico City", code: "MMMX", out: "685+", in: "686+" }
            ],
             "South America": [
                 { city: "São Paulo", code: "SBGR", out: "791", in: "792" }, { city: "Rio de Janeiro", code: "SBGL", out: "705", in: "706" }, { city: "Buenos Aires", code: "SAEZ", out: "701", in: "702" }, { city: "Lima", code: "SPJC", out: "743", in: "744" }, { city: "Bogotá", code: "SKBO", out: "741", in: "742" }, { city: "Quito", code: "SEQM", out: "751", in: "752" }, { city: "Guayaquil", code: "SEGU", out: "755", in: "756" }, { city: "Paramaribo", code: "SMJP", out: "713", in: "714" }, { city: "Aruba", code: "TNCA", out: "765", in: "766" }, { city: "Curaçao", code: "TNCC", out: "735", in: "736" }, { city: "St. Maarten", code: "TNCM", out: "777", in: "778" }
             ],
            "Africa": [
                 { city: "Nairobi", code: "HKJK", out: "565", in: "566" }, { city: "Dar es Salaam", code: "HTDA", out: "515", in: "516" }, { city: "Johannesburg", code: "FAOR", out: "591", in: "592" }, { city: "Cape Town", code: "FACT", out: "595+", in: "596+" }, { city: "Accra", code: "DGAA", out: "589", in: "590" }, { city: "Lagos", code: "DNMM", out: "587", in: "588" }, { city: "Kigali", code: "HRYR", out: "535", in: "536*" }, { city: "Entebbe", code: "HUEN", out: "535", in: "536" }
            ],
            "Asia": [
                 { city: "Tokyo", code: "RJAA", out: "861", in: "862" }, { city: "Seoul", code: "RKSI", out: "855", in: "856" }, { city: "Singapore", code: "WSSS", out: "835", in: "836" }, { city: "Hong Kong", code: "VHHH", out: "887", in: "888" }, { city: "Delhi", code: "VIDP", out: "871", in: "872" }, { city: "Mumbai", code: "VABB", out: "877", in: "878" }, { city: "Bangalore", code: "VOBL", out: "879", in: "880" }, { city: "Beijing", code: "ZBAA", out: "897", in: "898" }, { city: "Shanghai", code: "ZSPD", out: "895", in: "896" }, { city: "Bangkok", code: "VTBS", out: "843", in: "844" }, { city: "Kuala Lumpur", code: "WMKK", out: "809", in: "810" }, { city: "Jakarta", code: "WIII", out: "809", in: "810" }, { city: "Manila", code: "RPLL", out: "807", in: "808" }, { city: "Taipei", code: "RCTP", out: "807", in: "808" }, { city: "Denpasar", code: "WADD", out: "835", in: "836" }
            ],
            "Middle East": [
                { city: "Dubai", code: "OMDB", out: "427", in: "428" }, { city: "Tel Aviv", code: "LLBG", out: "461", in: "462" }
            ]
        };

        const pages = {
            home: `
                <div class="relative bg-slate-900 text-white fade-in min-h-[90vh] flex flex-col">
                    <div class="relative py-24 px-4 sm:px-6 lg:px-8 flex-grow">
                         <div class="absolute inset-0 z-0">
                            <img src="${siteImages.homeHero}" class="w-full h-full object-cover opacity-20" alt="KLM Ops">
                            <div class="absolute inset-0 bg-gradient-to-b from-slate-900 via-transparent to-slate-900"></div>
                        </div>
                        
                        <div class="relative z-10 max-w-7xl mx-auto">
                             <div class="inline-flex items-center gap-2 bg-klm/20 border border-klm/50 text-klm-sky px-4 py-1.5 rounded-full mb-8 backdrop-blur-md">
                                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                <span class="text-xs font-bold tracking-widest uppercase">Ops Normal</span>
                            </div>
                            <h1 class="text-5xl md:text-7xl font-black tracking-tight mb-6 leading-tight max-w-3xl">
                                Flying the World, <span class="text-klm">Virtually.</span>
                            </h1>
                            <p class="text-xl text-slate-300 mb-10 max-w-2xl font-light">Join a small, active, operations-focused community with realistic procedures and elite standards.</p>
                            
                            <!-- LIVE DISPATCH BOARD -->
                            <div class="mt-12">
                                <div class="flex justify-between items-center mb-4 max-w-5xl">
                                    <h3 class="text-xl font-bold flex items-center">
                                        <i data-lucide="monitor" class="w-5 h-5 mr-2 text-amber-500"></i> 
                                        Live Dispatch Board
                                    </h3>
                                    <!-- SYSTEM STATUS LIGHT -->
                                    <div class="flex items-center gap-2 bg-slate-800 px-3 py-1 rounded border border-slate-700">
                                        <div id="db-status-light" class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                                        <span id="db-status-text" class="text-[10px] font-mono font-bold text-red-400 uppercase tracking-wider">OFFLINE</span>
                                    </div>
                                </div>
                                
                                <div class="fids-board max-w-5xl shadow-2xl">
                                    <div class="fids-header">
                                        <div>Pilot</div>
                                        <div>Flight</div>
                                        <div>Time</div>
                                        <div class="hidden md:block">Route</div>
                                        <div>Aircraft</div>
                                        <div class="text-right">Status</div>
                                    </div>
                                    <div id="dispatch-rows" class="min-h-[100px]">
                                        <div class="p-4 text-center text-slate-500 italic">Connecting to Dispatch Server...</div>
                                    </div>
                                </div>
                                <p class="text-xs text-slate-500 mt-2">Use the <strong>Dispatch</strong> page or Discord bot to book flights.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `,
            
            news: `
                <div class="relative bg-slate-900 py-24 fade-in">
                    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="border-b border-slate-700 pb-8 mb-12">
                            <h1 class="text-4xl font-black text-white mb-4">Operational Directives</h1>
                            <p class="text-slate-400 text-lg">Fleet strategy, route adjustments, and airspace advisories.</p>
                        </div>
                        
                        <div class="space-y-12">
                             <article class="bg-slate-800/50 rounded-lg p-8 border-l-4 border-indigo-500">
                                <div class="flex items-center gap-3 mb-4 text-xs font-mono text-indigo-400 uppercase tracking-widest">
                                    <span>20 JAN 2026</span>
                                    <span>//</span>
                                    <span>Fleet Strategy</span>
                                </div>
                                <h2 class="text-2xl font-bold text-white mb-4">End of an Era — Fleet Renewal</h2>
                                <div class="text-slate-300 space-y-4 leading-relaxed">
                                    <p>KLM Virtual Airlines is officially closing one chapter and stepping into a new era. We have begun phasing out legacy workhorses: the B777-300ER and A330-200. Five 777 units have already been transferred.</p>
                                    <p>Simultaneously, we are divesting the B737NG fleet to pave the way for a streamlined A320neo/A321neo core. This fleet renewal reflects our commitment to realism and sustainability.</p>
                                    <ul class="list-disc list-inside bg-slate-900/50 p-4 rounded border border-slate-700 text-sm">
                                        <li><strong class="text-white">Q2 2026:</strong> A350-1000 deliveries (New Flagship).</li>
                                        <li><strong class="text-white">Q1 2027:</strong> Full fleet modernization complete.</li>
                                    </ul>
                                </div>
                            </article>
                        </div>
                    </div>
                </div>
            `,

            fleet: `
                <div class="relative bg-slate-900 py-24 fade-in">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="text-center mb-16">
                            <h1 class="text-4xl font-black text-white mb-4">Fleet Manifest</h1>
                            <p class="text-slate-400 max-w-2xl mx-auto">Strategic asset allocation. Our fleet is modernized for efficiency and operational realism.</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            ${fleetData.map(plane => {
                                let statusColor = plane.status === 'Active' ? 'text-emerald-400 border-emerald-500/30 bg-emerald-500/10' : 
                                                  plane.status === 'Phasing Out' ? 'text-amber-400 border-amber-500/30 bg-amber-500/10' : 
                                                  'text-indigo-400 border-indigo-500/30 bg-indigo-500/10';
                                return `
                                <div class="bg-slate-800 rounded-lg overflow-hidden border border-slate-700 hover:border-klm transition group">
                                    <div class="h-48 overflow-hidden relative">
                                        <img src="${plane.img}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 group-hover:scale-105 transition duration-700" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/thumb/a/ac/No_image_available.svg/1024px-No_image_available.svg.png'">
                                        <div class="absolute top-3 right-3 ${statusColor} border px-2 py-1 rounded text-xs font-bold uppercase tracking-wider backdrop-blur-md">
                                            ${plane.status}
                                        </div>
                                    </div>
                                    <div class="p-6">
                                        <div class="flex justify-between items-baseline mb-2">
                                            <h3 class="text-xl font-bold text-white">${plane.type}</h3>
                                            <span class="text-slate-500 text-sm font-mono">QTY: ${plane.count}</span>
                                        </div>
                                        <div class="text-klm text-xs font-bold uppercase tracking-wide mb-3">${plane.role}</div>
                                        <div class="text-[10px] text-slate-500 font-mono mb-2">ICAO: ${plane.icao}</div>
                                        <p class="text-slate-400 text-sm leading-relaxed border-t border-slate-700 pt-3">${plane.desc}</p>
                                    </div>
                                </div>
                                `
                            }).join('')}
                        </div>
                    </div>
                </div>
            `,

            booking: `
                <div class="relative bg-slate-50 py-12 fade-in">
                    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="mb-8">
                            <h1 class="text-3xl font-black text-slate-900">Flight Dispatch</h1>
                            <p class="text-slate-500">Create a flight plan and book your slot on the operations board.</p>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <!-- Booking Form -->
                            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                <form id="booking-form" onsubmit="window.handleBookingSubmit(event)">
                                    
                                    <div class="mb-6 border-b border-slate-100 pb-6">
                                        <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">Pilot Identification</h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="login-section">
                                            <!-- Dynamically filled by JS -->
                                        </div>
                                    </div>

                                    <div class="mb-6 border-b border-slate-100 pb-6">
                                        <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">Flight Parameters</h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                            <div>
                                                <label class="block text-sm font-medium text-slate-700 mb-1">Direction</label>
                                                <div class="flex gap-2">
                                                    <button type="button" onclick="window.setDirection('out')" id="btn-out" class="flex-1 py-2 border rounded font-bold text-sm bg-klm text-white border-klm">Outbound</button>
                                                    <button type="button" onclick="window.setDirection('in')" id="btn-in" class="flex-1 py-2 border rounded font-bold text-sm bg-white text-slate-600 border-slate-300">Inbound</button>
                                                </div>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-slate-700 mb-1">Region</label>
                                                <select id="region-select" onchange="window.updateDestinations()" class="w-full bg-slate-50 border border-slate-300 rounded p-2 outline-none"></select>
                                            </div>
                                        </div>

                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                            <div>
                                                <label class="block text-sm font-medium text-slate-700 mb-1">Destination / Origin</label>
                                                <select id="dest-select" onchange="window.updateFlightDetails()" class="w-full bg-slate-50 border border-slate-300 rounded p-2 outline-none"></select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-slate-700 mb-1">Flight Number</label>
                                                <select id="flight-select" onchange="window.updatePreview()" class="w-full bg-slate-50 border border-slate-300 rounded p-2 outline-none"></select>
                                            </div>
                                        </div>

                                        <div class="bg-slate-100 rounded p-3 flex justify-between items-center text-sm font-mono text-slate-600 border border-slate-200">
                                            <div class="text-center">
                                                <div class="text-[10px] uppercase text-slate-400">Departure</div>
                                                <div id="disp-dep" class="font-bold text-lg text-slate-900">----</div>
                                            </div>
                                            <div class="text-slate-400">
                                                <i data-lucide="plane" class="w-5 h-5 rotate-90"></i>
                                            </div>
                                            <div class="text-center">
                                                <div class="text-[10px] uppercase text-slate-400">Arrival</div>
                                                <div id="disp-arr" class="font-bold text-lg text-slate-900">----</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-6 border-b border-slate-100 pb-6">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-slate-700 mb-1">Aircraft</label>
                                                <select id="aircraft-select" onchange="window.updatePreview()" class="w-full bg-slate-50 border border-slate-300 rounded p-2 outline-none"></select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-slate-700 mb-1">Departure Time (Zulu)</label>
                                                <input type="time" id="dep-time" onchange="window.updatePreview()" required class="w-full bg-slate-50 border border-slate-300 rounded p-2 outline-none">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- NEW: TEST FLIGHT CHECKBOX -->
                                    <div class="mb-8">
                                        <label class="flex items-center gap-3 cursor-pointer group">
                                            <div class="relative">
                                                <input type="checkbox" id="is-test-flight" class="sr-only peer">
                                                <div class="w-10 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-klm/20 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-klm"></div>
                                            </div>
                                            <span class="text-sm font-bold text-slate-600 group-hover:text-klm transition">Mark as Test Flight</span>
                                            <div class="bg-amber-100 text-amber-700 text-[10px] font-bold px-2 py-0.5 rounded border border-amber-200 uppercase tracking-wider">Board status: TEST</div>
                                        </label>
                                    </div>

                                    <button type="submit" class="w-full bg-klm hover:bg-klm-dark text-white font-bold py-3 rounded shadow-lg transition transform active:scale-95 flex justify-center items-center">
                                        <i data-lucide="check-circle" class="w-5 h-5 mr-2"></i> Confirm Booking
                                    </button>

                                </form>
                            </div>

                            <!-- Flight Strip -->
                            <div class="lg:col-span-1">
                                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">Flight Strip Preview</h3>
                                <div class="bg-slate-800 text-white p-4 rounded-lg shadow-xl border-l-4 border-amber-500 font-mono text-sm relative overflow-hidden">
                                    <div class="flex justify-between items-start mb-4 relative z-10">
                                        <div>
                                            <div class="text-xs text-slate-400">CALLSIGN</div>
                                            <div class="text-xl font-bold text-amber-400" id="preview-callsign">KLM---</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-xs text-slate-400">AIRCRAFT</div>
                                            <div class="font-bold" id="preview-ac">---</div>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-4 mb-4 relative z-10">
                                        <div class="bg-slate-900/50 p-2 rounded">
                                            <div class="text-[10px] text-slate-400">DEP</div>
                                            <div class="font-bold text-lg" id="preview-dep">----</div>
                                        </div>
                                        <div class="bg-slate-900/50 p-2 rounded text-right">
                                            <div class="text-[10px] text-slate-400">ARR</div>
                                            <div class="font-bold text-lg" id="preview-arr">----</div>
                                        </div>
                                    </div>

                                    <div class="border-t border-slate-700 pt-3 relative z-10">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <div class="text-[10px] text-slate-400">PIC</div>
                                                <div class="font-bold truncate max-w-[120px]" id="preview-pilot">---</div>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-[10px] text-slate-400">EOBT</div>
                                                <div class="font-bold text-emerald-400" id="preview-time">--:--</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `,

            routes: `
                <div class="relative bg-white py-24 fade-in">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex flex-col md:flex-row gap-12 mb-12">
                            <div class="md:w-1/3">
                                <h1 class="text-4xl font-black text-slate-900 mb-6">Network Deployment</h1>
                                <p class="text-slate-600 leading-relaxed mb-6">
                                    Our route network is built around <strong>Amsterdam (EHAM)</strong> as a hub, with routes deployed strategically based on fleet capability.
                                </p>
                            </div>
                            <div class="md:w-2/3 relative h-[400px] bg-slate-900 rounded-xl overflow-hidden border border-slate-800 shadow-2xl">
                                <div id="fleet-map"></div>
                            </div>
                        </div>

                        <div class="flex flex-wrap gap-2 mb-8 border-b border-slate-200 pb-4">
                            ${Object.keys(routeData).map(region => `
                                <button onclick="window.renderRouteGrid('${region}')" 
                                    class="route-btn px-4 py-2 rounded text-sm font-bold uppercase tracking-wide transition focus:outline-none"
                                    id="btn-${region}">
                                    ${region}
                                </button>
                            `).join('')}
                        </div>
                        <div id="route-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
                    </div>
                </div>
            `,

            livemap: `
                <div class="flex flex-col h-[calc(100vh-80px)] fade-in">
                    <div class="bg-slate-900 px-6 py-4 flex justify-between items-center border-b border-slate-800">
                        <div>
                            <h1 class="text-xl font-bold text-white flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> 
                                LIVE OPERATIONS
                            </h1>
                        </div>
                    </div>
                    <div class="flex-grow bg-slate-800 relative">
                        <iframe src="https://radarthing.com/?callsign=KLM" class="absolute inset-0 w-full h-full border-0" allowfullscreen></iframe>
                    </div>
                </div>
            `,

            sop: `
                <div class="bg-slate-50 py-24 fade-in">
                    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="text-center mb-16">
                            <h1 class="text-4xl font-black text-slate-900 mb-4">Standard Operating Procedures</h1>
                            <p class="text-slate-600 max-w-2xl mx-auto">Discipline is what separates us from the rest.</p>
                        </div>
                        <div class="space-y-8">
                            <div class="bg-white p-8 rounded-xl shadow-sm border-l-4 border-klm">
                                <h3 class="text-xl font-bold text-slate-900 mb-4">Phase 1: Preparation</h3>
                                <p class="text-slate-600">SimBrief Flight Plan Mandatory. Doors closed 5-15 min prior to departure.</p>
                            </div>
                            <div class="bg-white p-8 rounded-xl shadow-sm border-l-4 border-klm">
                                <h3 class="text-xl font-bold text-slate-900 mb-4">Phase 2: Execution</h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                    <div class="p-3 bg-slate-50 border"><strong>Taxi</strong><br>Max 25 kts</div>
                                    <div class="p-3 bg-slate-50 border"><strong>&lt;10k ft</strong><br>250 kts</div>
                                    <div class="p-3 bg-slate-50 border"><strong>Cruise</strong><br>Cost Index</div>
                                    <div class="p-3 bg-slate-50 border"><strong>Sep</strong><br>1000ft</div>
                                </div>
                            </div>
                            <div class="bg-white p-8 rounded-xl shadow-sm border-l-4 border-klm">
                                <h3 class="text-xl font-bold text-slate-900 mb-4">Phase 3: Validation</h3>
                                <p class="text-slate-600">Submit logs to Discord channel with Dep/Arr, Time, Name, and Screenshot.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `,

            partners: `
                <div class="bg-white py-24 fade-in">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="bg-slate-900 rounded-2xl p-8 md:p-12 mb-16 text-white relative overflow-hidden">
                             <div class="relative z-10 flex flex-col md:flex-row gap-12 items-center">
                                <div class="md:w-1/2">
                                    <div class="text-amber-400 text-xs font-bold uppercase tracking-widest mb-2">Parent Airline Group</div>
                                    <h2 class="text-4xl font-bold mb-4">Lufthansa Group (DLH)</h2>
                                    <p class="text-slate-300 text-lg leading-relaxed mb-6">
                                        DLH holds a minority stake, providing operational stability while KLM VA runs independently, focused on active pilots and realistic operations.
                                    </p>
                                    <div class="flex gap-4">
                                        <a href="https://midmm2tehdumb.github.io/Lufthansa-Group/index.html" target="_blank" class="border border-white/20 hover:bg-white/10 px-6 py-2 rounded font-bold transition">Visit DLH</a>
                                        <a href="https://discord.gg/TJRUPZj3t9" target="_blank" class="bg-amber-500 hover:bg-amber-600 text-slate-900 px-6 py-2 rounded font-bold transition">Discord</a>
                                    </div>
                                </div>
                                <div class="md:w-1/2 grid grid-cols-2 gap-4">
                                    <div class="bg-white/5 p-4 rounded border border-white/10">
                                        <div class="text-2xl font-bold text-amber-400">Platinum</div>
                                        <div class="text-xs text-slate-400 uppercase">GASA Rating</div>
                                    </div>
                                    <div class="bg-white/5 p-4 rounded border border-white/10">
                                        <div class="text-2xl font-bold text-amber-400">A+</div>
                                        <div class="text-xs text-slate-400 uppercase">ICAO Rating</div>
                                    </div>
                                </div>
                             </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                             <div class="bg-slate-50 p-6 rounded-lg border border-slate-200">
                                <h4 class="font-bold text-klm mb-2">GASA (Safety Authority)</h4>
                                <p class="text-sm text-slate-600 mb-3">Ensures safety, fairness, and realism. Operating as a neutral global oversight body.</p>
                            </div>
                            <div class="bg-slate-50 p-6 rounded-lg border border-slate-200">
                                <h4 class="font-bold text-sky-600 mb-2">ICAO Community</h4>
                                <p class="text-sm text-slate-600 mb-3">Prevents chaos and fragmentation. Provides the shared framework for recognition.</p>
                                <div class="inline-block bg-green-100 text-green-800 text-xs font-bold px-2 py-1 rounded">Certified Organisation</div>
                            </div>
                        </div>
                    </div>
                </div>
            `,

            community: `
                <div class="bg-slate-900 py-24 fade-in">
                    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="text-center mb-16">
                            <h1 class="text-4xl font-black text-white mb-6">The Elite Core</h1>
                            <p class="text-slate-400 text-xl max-w-3xl mx-auto leading-relaxed">
                                KLM VA is small, elite, and operations-first. Every member matters — we value skill, realism, and commitment over numbers.
                            </p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-24">
                            <!-- Trainee -->
                            <div class="bg-slate-800 p-6 rounded-lg border border-slate-700 text-center group hover:border-klm transition duration-300">
                                <div class="epaulette mb-4 mx-auto group-hover:scale-110 transition duration-300">
                                    <div class="stripe"></div>
                                </div>
                                <h3 class="text-white font-bold text-lg">Trainee</h3>
                                <div class="text-slate-400 text-sm font-mono mt-2 mb-4">0 - 5 Hours</div>
                                <div class="inline-block bg-slate-900/50 text-indigo-300 text-[10px] uppercase font-bold px-3 py-1 rounded border border-indigo-500/20">
                                    Entry Exams
                                </div>
                            </div>

                            <!-- Junior Officer -->
                            <div class="bg-slate-800 p-6 rounded-lg border border-slate-700 text-center group hover:border-klm transition duration-300">
                                <div class="epaulette mb-4 mx-auto group-hover:scale-110 transition duration-300">
                                    <div class="stripe"></div><div class="stripe"></div>
                                </div>
                                <h3 class="text-white font-bold text-lg">Junior Officer</h3>
                                <div class="text-slate-400 text-sm font-mono mt-2 mb-4">5 - 15 Hours</div>
                                <div class="inline-block bg-slate-900/50 text-emerald-300 text-[10px] uppercase font-bold px-3 py-1 rounded border border-emerald-500/20">
                                    Short Haul Ops
                                </div>
                            </div>

                            <!-- First Officer -->
                            <div class="bg-slate-800 p-6 rounded-lg border border-slate-700 text-center group hover:border-klm transition duration-300">
                                <div class="epaulette mb-4 mx-auto group-hover:scale-110 transition duration-300">
                                    <div class="stripe"></div><div class="stripe"></div><div class="stripe"></div>
                                </div>
                                <h3 class="text-white font-bold text-lg">First Officer</h3>
                                <div class="text-slate-400 text-sm font-mono mt-2 mb-4">15 - 50 Hours</div>
                                <div class="inline-block bg-slate-900/50 text-sky-300 text-[10px] uppercase font-bold px-3 py-1 rounded border border-sky-500/20">
                                    Medium Haul Ops
                                </div>
                            </div>

                            <!-- Captain -->
                            <div class="bg-slate-800 p-6 rounded-lg border border-slate-700 text-center group hover:border-klm transition duration-300">
                                <div class="epaulette mb-4 mx-auto group-hover:scale-110 transition duration-300">
                                    <div class="stripe"></div><div class="stripe"></div><div class="stripe"></div><div class="stripe"></div>
                                </div>
                                <h3 class="text-white font-bold text-lg">Captain</h3>
                                <div class="text-slate-400 text-sm font-mono mt-2 mb-4">50+ Hours</div>
                                <div class="inline-block bg-slate-900/50 text-amber-300 text-[10px] uppercase font-bold px-3 py-1 rounded border border-amber-500/20">
                                    Long Haul Command
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl p-8 md:p-12">
                            <h3 class="text-2xl font-bold text-slate-900 mb-8">Code of Conduct</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                                <div>
                                    <h4 class="font-bold text-klm mb-2">01. Professionalism</h4>
                                    <p class="text-sm text-slate-600">Communication must be courteous. Disrespect is not tolerated in our airspace.</p>
                                </div>
                                <div>
                                    <h4 class="font-bold text-klm mb-2">02. Integrity</h4>
                                    <p class="text-sm text-slate-600">Operational honesty is paramount. Logs must be accurate and verifiable.</p>
                                </div>
                                <div>
                                    <h4 class="font-bold text-klm mb-2">03. Chain of Command</h4>
                                    <p class="text-sm text-slate-600">Respect staff decisions. They ensure the integrity of the VA.</p>
                                </div>
                                <div>
                                    <h4 class="font-bold text-klm mb-2">04. Privacy</h4>
                                    <p class="text-sm text-slate-600">Protect member data. Doxxing or sharing private info results in immediate expulsion.</p>
                                </div>
                                <div>
                                    <h4 class="font-bold text-klm mb-2">05. Safety</h4>
                                    <p class="text-sm text-slate-600">Strictly SFW environment. We maintain a professional simulation atmosphere.</p>
                                </div>
                                <div>
                                    <h4 class="font-bold text-klm mb-2">06. Excellence</h4>
                                    <p class="text-sm text-slate-600">We fly to a higher standard. Continual improvement is expected.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `
        };

        // --- FIXED ROUTER LOGIC ---
        let dispatchUnsubscribe = null; 

        function router(pageName) {
            if (dispatchUnsubscribe) {
                dispatchUnsubscribe();
                dispatchUnsubscribe = null;
            }
            const contentDiv = document.getElementById('app-content');
            contentDiv.innerHTML = pages[pageName] || pages['home'];
            if (pageName === 'routes') { setTimeout(() => { initFleetMap(); renderRouteGrid('Europe'); }, 100); }
            if (pageName === 'booking') { setTimeout(initBookingPage, 100); }
            if (pageName === 'home') { setTimeout(initDispatchBoard, 500); }
            lucide.createIcons();
            window.scrollTo(0, 0);
            document.querySelectorAll('.nav-link').forEach(btn => {
                if(btn.getAttribute('onclick').includes(pageName)) {
                    btn.classList.add('active', 'text-klm');
                    btn.classList.remove('text-slate-600');
                } else {
                    btn.classList.remove('active', 'text-klm');
                    btn.classList.add('text-slate-600');
                }
            });
        }
        window.router = router;

        // --- BOOKING LOGIC ---
        let currentDirection = 'out';
        let bookingRouteList = [];

        function initBookingPage() {
            const regionSelect = document.getElementById('region-select');
            const acSelect = document.getElementById('aircraft-select');
            const loginSection = document.getElementById('login-section');
            const regions = Object.keys(routeData);
            if(regionSelect) regionSelect.innerHTML = regions.map(r => `<option value="${r}">${r}</option>`).join('');
            if(acSelect) acSelect.innerHTML = fleetData.filter(f => f.status === 'Active' || f.status === 'Phasing Out').map(f => `<option value="${f.type}">${f.type}</option>`).join('');
            if(loginSection) {
                if(discordUser) {
                    loginSection.innerHTML = `
                        <div class="col-span-2 flex items-center gap-4 bg-slate-50 p-4 rounded border border-emerald-200">
                             <img src="https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png" 
                                  class="w-12 h-12 rounded-full border-2 border-white shadow" 
                                  onerror="this.src='https://cdn.discordapp.com/embed/avatars/0.png'">
                             <div>
                                <div class="text-sm text-slate-500 font-bold uppercase tracking-wider">Authenticated Pilot</div>
                                <div class="text-lg font-black text-slate-800">${discordUser.username}</div>
                             </div>
                             <div class="ml-auto bg-emerald-100 text-emerald-700 px-3 py-1 rounded text-xs font-bold uppercase tracking-wide">
                                <i data-lucide="check-circle" class="w-3 h-3 inline mr-1"></i> Verified
                             </div>
                        </div>
                    `;
                    lucide.createIcons();
                } else {
                    const discordAuthUrl = "https://discord.com/oauth2/authorize?client_id=1464272995542634566&response_type=token&redirect_uri=https%3A%2F%2Fklmgeofsvirtual.github.io%2Fklm-virtual-airline%2F&scope=identify+email+guilds.members.read";
                    loginSection.innerHTML = `
                        <div class="col-span-2">
                             <a href="${discordAuthUrl}" class="flex items-center justify-center w-full bg-[#5865F2] hover:bg-[#4752C4] text-white font-bold py-3 rounded transition shadow-lg transform active:scale-95">
                                <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037 20.818 20.818 0 0 0-3.361 6.91 20.8 20.8 0 0 0-3.356-6.91.071.071 0 0 0-.077-.037 19.782 19.782 0 0 0-4.886 1.515.072.072 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.086 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.086 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
                                </svg>
                                Log in with Discord
                            </a>
                            <p class="text-xs text-center text-slate-500 mt-2">Required for pilot identification.</p>
                        </div>
                    `;
                }
            }
            updateDestinations();
        }

        function setDirection(dir) {
            currentDirection = dir;
            const btnOut = document.getElementById('btn-out');
            const btnIn = document.getElementById('btn-in');
            if(dir === 'out') {
                btnOut.className = "flex-1 py-2 border rounded font-bold text-sm bg-klm text-white border-klm transition";
                btnIn.className = "flex-1 py-2 border rounded font-bold text-sm bg-white text-slate-600 border-slate-300 transition";
            } else {
                btnOut.className = "flex-1 py-2 border rounded font-bold text-sm bg-white text-slate-600 border-slate-300 transition";
                btnIn.className = "flex-1 py-2 border rounded font-bold text-sm bg-klm text-white border-klm transition";
            }
            updateFlightDetails();
        }
        window.setDirection = setDirection;

        function updateDestinations() {
            const region = document.getElementById('region-select').value;
            const destSelect = document.getElementById('dest-select');
            if(routeData[region]) {
                bookingRouteList = routeData[region];
                destSelect.innerHTML = bookingRouteList.map((route, index) => 
                    `<option value="${index}">${route.city} (${route.code})</option>`
                ).join('');
                updateFlightDetails();
            }
        }
        window.updateDestinations = updateDestinations;

        function updateFlightDetails() {
            const index = document.getElementById('dest-select').value;
            const flightSelect = document.getElementById('flight-select');
            const route = bookingRouteList[index];
            if (!route) return;
            if (currentDirection === 'out') {
                document.getElementById('disp-dep').textContent = "EHAM";
                document.getElementById('disp-arr').textContent = route.code;
            } else {
                document.getElementById('disp-dep').textContent = route.code;
                document.getElementById('disp-arr').textContent = "EHAM";
            }
            const rawString = currentDirection === 'out' ? route.out : route.in;
            const cleanString = rawString.replace(/[+*]/g, '');
            const numbers = cleanString.split(',').map(s => s.trim()).filter(s => s);
            flightSelect.innerHTML = numbers.map(num => `<option value="KL${num}">KL${num}</option>`).join('');
            updatePreview();
        }
        window.updateFlightDetails = updateFlightDetails;

        function updatePreview() {
            const callsign = document.getElementById('flight-select').value || '---';
            const dep = document.getElementById('disp-dep').textContent;
            const arr = document.getElementById('disp-arr').textContent;
            const pilot = discordUser ? discordUser.username : '---';
            const ac = document.getElementById('aircraft-select').value || '---';
            const time = document.getElementById('dep-time').value || '--:--';
            document.getElementById('preview-callsign').textContent = callsign;
            document.getElementById('preview-dep').textContent = dep;
            document.getElementById('preview-arr').textContent = arr;
            document.getElementById('preview-pilot').textContent = pilot;
            document.getElementById('preview-ac').textContent = ac;
            document.getElementById('preview-time').textContent = time + 'z';
        }
        window.updatePreview = updatePreview;

        // --- SUBMIT TO FIREBASE (ASYNC) ---
        async function handleBookingSubmit(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            if (!discordUser) { alert("You must log in with Discord first!"); return; }
            btn.innerHTML = `<i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i> Processing...`;
            btn.disabled = true;

            const pilotName = discordUser.username;
            const flightNumber = document.getElementById('flight-select').value;
            const destination = document.getElementById('disp-arr').textContent;
            const departure = document.getElementById('disp-dep').textContent;
            const aircraftType = document.getElementById('aircraft-select').value;
            const timeVal = document.getElementById('dep-time').value;
            
            // CHECK TEST CHECKBOX
            const isTest = document.getElementById('is-test-flight').checked;
            const finalStatus = isTest ? "TEST" : "BOOKED";

            const selectedFleet = fleetData.find(f => f.type === aircraftType);
            const today = new Date();
            const [hours, minutes] = timeVal.split(':');
            today.setHours(hours, minutes, 0, 0);
            const scheduledDepartureISO = today.toISOString();

            if (!db) { alert("Database not connected."); btn.innerHTML = originalText; btn.disabled = false; return; }

            try {
                await addDoc(collection(db, "bookings"), {
                    flightNumber: flightNumber,
                    aircraft: { name: selectedFleet.type, icao: selectedFleet.icao },
                    departure: departure,
                    destination: destination,
                    pilot: { discordId: discordUser.id, callsign: pilotName, username: discordUser.username },
                    status: finalStatus, // Use determined status
                    scheduledDeparture: scheduledDepartureISO,
                    createdAt: serverTimestamp()
                });
                alert("Booking Confirmed!");
                router('home');
            } catch (error) {
                console.error("Error writing document: ", error);
                document.getElementById('db-error-banner').classList.remove('hidden');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        window.handleBookingSubmit = handleBookingSubmit;

        // --- DISPATCH BOARD (HOME) ---
        function initDispatchBoard() {
            const board = document.getElementById('dispatch-rows');
            if(!board || !db) return;
            const q = query(collection(db, "bookings"), orderBy("createdAt", "desc"), limit(10));
            dispatchUnsubscribe = onSnapshot(q, (querySnapshot) => {
                const statusLight = document.getElementById('db-status-light');
                const statusText = document.getElementById('db-status-text');
                const errorBanner = document.getElementById('db-error-banner');
                const boardEl = document.getElementById('dispatch-rows');
                if (statusLight) {
                    statusLight.classList.remove('bg-red-500', 'animate-pulse');
                    statusLight.classList.add('bg-emerald-500');
                    statusText.textContent = "SYSTEM ONLINE";
                    statusText.classList.remove('text-red-400');
                    statusText.classList.add('text-emerald-400');
                    if (errorBanner) errorBanner.classList.add('hidden');
                }
                if (boardEl) {
                    boardEl.innerHTML = "";
                    if(querySnapshot.empty) {
                        boardEl.innerHTML = '<div class="p-4 text-center text-slate-500">No active flights.</div>';
                        return;
                    }
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const pilotName = data.pilot?.callsign || 'Unknown';
                        const flightNum = data.flightNumber || '---';
                        const aircraftName = data.aircraft?.name || '---';
                        const dest = data.destination || '---';
                        const status = data.status || 'BOOKED';
                        
                        // Handle Colors for Status
                        const statusColor = status === 'TEST' ? 'text-amber-400' : 'text-emerald-400';

                        let timeStr = '--:--z';
                        if (data.scheduledDeparture) {
                            try {
                                const date = new Date(data.scheduledDeparture);
                                timeStr = date.toLocaleTimeString('en-GB', {hour: '2-digit', minute:'2-digit', timeZone: 'UTC'}) + 'z';
                            } catch (e) {}
                        }
                        const row = document.createElement('div');
                        row.className = 'fids-row';
                        row.innerHTML = `
                            <div class="font-bold text-klm truncate">${pilotName}</div>
                            <div>${flightNum}</div>
                            <div class="font-mono text-amber-500 font-bold">${timeStr}</div>
                            <div class="hidden md:block">EHAM ➝ ${dest}</div>
                            <div>${aircraftName}</div>
                            <div class="text-right font-bold uppercase ${statusColor} animate-pulse">${status}</div>
                        `;
                        boardEl.appendChild(row);
                    });
                }
            }, (error) => {
                const statusLight = document.getElementById('db-status-light');
                const statusText = document.getElementById('db-status-text');
                const errorBanner = document.getElementById('db-error-banner');
                if(errorBanner) errorBanner.classList.remove('hidden');
                if (statusLight) {
                    statusLight.classList.add('bg-red-500', 'animate-pulse');
                    statusText.textContent = "CONNECTION LOST";
                }
            });
        }

        // --- MAP LOGIC (UNCHANGED) ---
        let mapInstance = null;
        let flightLinesLayer = null;
        const routeManifest = [
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "EGLL", "destinationCoords": [-0.4543, 51.4700], "fleet": ["E190", "E195", "B737-700", "B737-800", "A321neo"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "LFPG", "destinationCoords": [2.5479, 49.0097], "fleet": ["E190", "E195", "B737-700", "B737-800", "A321neo"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "EDDB", "destinationCoords": [13.5033, 52.3667], "fleet": ["E190", "E195", "B737-700", "B737-800", "A321neo"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "LIRF", "destinationCoords": [12.2508, 41.8003], "fleet": ["B737-800", "A321neo"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "LEMD", "destinationCoords": [-3.5668, 40.4893], "fleet": ["B737-800", "A321neo"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "LOWW", "destinationCoords": [16.5697, 48.1103], "fleet": ["E190", "E195", "B737-800"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "EBBR", "destinationCoords": [4.4844, 50.9014], "fleet": ["E190", "E195"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "LSZH", "destinationCoords": [8.5492, 47.4581], "fleet": ["E190", "E195", "B737-800"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "LSGG", "destinationCoords": [6.1092, 46.2370], "fleet": ["E190", "E195", "B737-800"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "ESSA", "destinationCoords": [17.9186, 59.6519], "fleet": ["E190", "E195", "B737-800"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "EKCH", "destinationCoords": [12.6560, 55.6180], "fleet": ["E190", "E195", "B737-800"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "ENGM", "destinationCoords": [11.1004, 60.1939], "fleet": ["E190", "E195"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "EFHK", "destinationCoords": [24.9633, 60.3172], "fleet": ["E190", "E195", "B737-800"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "LGAV", "destinationCoords": [23.9445, 37.9364], "fleet": ["B737-800", "A321neo"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "KJFK", "destinationCoords": [-73.7781, 40.6413], "fleet": ["B787-9", "B787-10", "B777-300ER"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "KATL", "destinationCoords": [-84.4277, 33.6407], "fleet": ["B787-9", "B777-300ER"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "KLAX", "destinationCoords": [-118.4085, 33.9416], "fleet": ["B787-10", "B777-300ER"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "KSFO", "destinationCoords": [-122.3790, 37.6213], "fleet": ["B787-9", "B787-10"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "KORD", "destinationCoords": [-87.9073, 41.9742], "fleet": ["B787-9"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "KBOS", "destinationCoords": [-71.0052, 42.3656], "fleet": ["B787-9"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "KIAD", "destinationCoords": [-77.4565, 38.9531], "fleet": ["B787-9"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "CYYZ", "destinationCoords": [-79.6248, 43.6777], "fleet": ["B777-300ER", "B787-10"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "SBGR", "destinationCoords": [-46.4731, -23.4356], "fleet": ["B777-300ER", "B787-9"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "SAEZ", "destinationCoords": [-58.5358, -34.8222], "fleet": ["B777-300ER"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "SKBO", "destinationCoords": [-74.1469, 4.7016], "fleet": ["B787-9"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "TNCA", "destinationCoords": [-70.0152, 12.5014], "fleet": ["A330-200"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "TNCM", "destinationCoords": [-63.1089, 18.0410], "fleet": ["A330-200"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "RJAA", "destinationCoords": [140.3929, 35.7719], "fleet": ["B787-9", "B777-300ER"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "VHHH", "destinationCoords": [113.9146, 22.3080], "fleet": ["B777-300ER"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "WSSS", "destinationCoords": [103.9940, 1.3644], "fleet": ["B787-10", "B777-300ER"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "OMDB", "destinationCoords": [55.3644, 25.2532], "fleet": ["B787-9", "B777-300ER"], "hub": true },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "LLBG", "destinationCoords": [34.8854, 32.0114], "fleet": ["B737-900"], "hub": true }
        ];

        function initFleetMap() {
            const container = document.getElementById('fleet-map');
            if (!container) return;
            if (mapInstance) { mapInstance.remove(); mapInstance = null; }
            mapInstance = L.map('fleet-map', { center: [30, 0], zoom: 2, minZoom: 2, maxBounds: [[-90, -180], [90, 180]], zoomControl: false, attributionControl: false });
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { subdomains: 'abcd', maxZoom: 19 }).addTo(mapInstance);
            flightLinesLayer = L.layerGroup().addTo(mapInstance);
            filterMapRoutes('ALL');
        }

        function filterMapRoutes(aircraftType) {
            if (!flightLinesLayer) return;
            flightLinesLayer.clearLayers();
            const hubIcon = L.divIcon({ className: 'custom-div-icon', html: "<div style='background-color:#00A1DE;width:8px;height:8px;border-radius:50%;box-shadow:0 0 15px #00A1DE;'></div>", iconSize: [8, 8], iconAnchor: [4, 4] });
            L.marker([52.3091, 4.7639], { icon: hubIcon }).addTo(flightLinesLayer);
            routeManifest.forEach(route => {
                const start = [route.originCoords[1], route.originCoords[0]];
                const end = [route.destinationCoords[1], route.destinationCoords[0]];
                const latlngs = getCurvePoints(start, end);
                const polyline = L.polyline(latlngs, { color: '#00A1DE', weight: 1, opacity: 0.4, smoothFactor: 1 });
                polyline.addTo(flightLinesLayer);
                L.circleMarker(end, { radius: 2, fillColor: '#fff', color: '#00A1DE', weight: 0, opacity: 1, fillOpacity: 0.8 }).addTo(flightLinesLayer);
            });
        }

        function getCurvePoints(start, end) {
            const lat1 = start[0], lng1 = start[1], lat2 = end[0], lng2 = end[1];
            const midLat = (lat1 + lat2) / 2, midLng = (lng1 + lng2) / 2;
            const dist = Math.sqrt(Math.pow(lat2 - lat1, 2) + Math.pow(lng2 - lng1, 2));
            const controlLat = midLat + (dist * 0.25), controlLng = midLng; 
            const points = [];
            for(let t=0; t<=1; t+=0.02) {
                const invT = 1 - t;
                const lat = (invT * invT * lat1) + (2 * invT * t * controlLat) + (t * t * lat2);
                const lng = (invT * invT * lng1) + (2 * invT * t * controlLng) + (t * t * lng2);
                points.push([lat, lng]);
            }
            points.push([lat2, lng2]); 
            return points;
        }

        function renderRouteGrid(region) {
            const grid = document.getElementById('route-grid');
            const data = routeData[region] || [];
            document.querySelectorAll('.route-btn').forEach(btn => {
                if(btn.id === `btn-${region}`) { btn.classList.add('bg-klm', 'text-white'); btn.classList.remove('bg-white', 'text-slate-600'); }
                else { btn.classList.remove('bg-klm', 'text-white'); btn.classList.add('bg-white', 'text-slate-600', 'border', 'border-slate-200'); }
            });
            grid.innerHTML = data.map(route => `
                <div class="bg-white p-4 rounded border border-slate-200 hover:border-klm transition">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-slate-800 text-sm truncate">${route.city}</span>
                        <span class="font-mono text-xs text-slate-400">${route.code}</span>
                    </div>
                    <div class="flex gap-2 text-[10px] font-mono text-slate-500">
                         <span class="bg-slate-100 px-1 rounded">OUT: ${route.out}</span>
                         <span class="bg-slate-100 px-1 rounded">IN: ${route.in}</span>
                    </div>
                </div>
            `).join('');
        }
        window.renderRouteGrid = renderRouteGrid;

        function toggleMobileMenu() { document.getElementById('mobile-menu').classList.toggle('hidden'); }
        window.toggleMobileMenu = toggleMobileMenu;

        document.getElementById('nav-logo').src = siteImages.logo;
        router('home');
    </script>
</body>
</html>
