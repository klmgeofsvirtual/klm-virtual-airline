<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KLM Virtual Airline | Operations Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Leaflet Map CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        /* Modernized KLM Brand Colors & Variables */
        :root {
            --klm-blue: #00A1DE; 
            --klm-dark: #0077A3;
            --klm-glow: rgba(0, 161, 222, 0.4);
            --discord: #5865F2;
            --discord-dark: #4752C4;
            --bg-base: #020617; /* slate-950 */
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-base);
            color: #f8fafc;
            overflow-x: hidden;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-base); }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #334155; }

        /* Sleek Utility Classes */
        .text-klm { color: var(--klm-blue); }
        .bg-klm { background-color: var(--klm-blue); }
        .glow-klm { box-shadow: 0 0 20px var(--klm-glow); }
        .text-gradient {
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-image: linear-gradient(90deg, #fff, #94a3b8);
        }
        .text-gradient-klm {
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-image: linear-gradient(90deg, #00A1DE, #38bdf8);
        }

        /* Glassmorphism Panels */
        .glass-panel {
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        .glass-nav {
            background: rgba(2, 6, 23, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Animations */
        .animate-slide-up {
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
            transform: translateY(20px);
        }
        .animate-fade-in {
            animation: fadeIn 0.8s ease-out forwards;
            opacity: 0;
        }
        
        /* Staggered animation delays */
        .delay-100 { animation-delay: 100ms; }
        .delay-200 { animation-delay: 200ms; }
        .delay-300 { animation-delay: 300ms; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Nav Active State */
        .nav-link { position: relative; }
        .nav-link::after {
            content: '';
            position: absolute;
            width: 0%;
            height: 2px;
            bottom: -4px;
            left: 0;
            background-color: var(--klm-blue);
            transition: width 0.3s ease;
        }
        .nav-link:hover::after, .nav-link.active::after { width: 100%; }
        .nav-link.active { color: #fff !important; font-weight: 600; }

        /* Map Styles */
        #fleet-map { width: 100%; height: 600px; background: #0f172a; z-index: 1; }

        /* FIDS Board */
        .fids-board {
            font-family: 'JetBrains Mono', 'Courier New', Courier, monospace;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .fids-header {
            background: rgba(2, 6, 23, 0.8);
            color: #64748b;
            font-weight: 700;
            padding: 16px 20px;
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr 1.5fr 1fr 1fr;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 2px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .fids-row {
            padding: 16px 20px;
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr 1.5fr 1fr 1fr;
            color: #e2e8f0;
            border-bottom: 1px solid rgba(255,255,255,0.02);
            font-size: 0.85rem;
            align-items: center;
            transition: all 0.2s ease;
        }
        .fids-row:hover { background-color: rgba(255,255,255,0.03); transform: scale(1.01); }
        .fids-row:last-child { border-bottom: none; }
        #dispatch-rows { max-height: 350px; overflow-y: auto; }
        
        /* Modern Inputs */
        .sleek-input {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s ease;
        }
        .sleek-input:focus {
            border-color: var(--klm-blue);
            box-shadow: 0 0 0 2px rgba(0, 161, 222, 0.2);
            outline: none;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Background Ambient Glow -->
    <div class="fixed inset-0 z-[-1] pointer-events-none overflow-hidden">
        <div class="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-klm/10 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-indigo-500/10 rounded-full blur-[120px]"></div>
    </div>

    <!-- ERROR BANNER -->
    <div id="db-error-banner" class="hidden bg-red-900/90 backdrop-blur-md border-b border-red-500/50 text-white px-4 py-3 text-center shadow-2xl z-[100] fixed w-full top-0">
        <div class="flex items-center justify-center gap-2">
            <i data-lucide="alert-triangle" class="w-5 h-5 text-red-400"></i>
            <span class="font-bold tracking-wide">SYSTEM ALERT:</span>
            <span class="text-sm text-red-100">Database connection lost. Functionality limited.</span>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="sticky top-0 z-50 glass-nav transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20">
                <div class="flex items-center cursor-pointer group" onclick="router('home')">
                    <img id="nav-logo" src="" alt="KLM Logo" class="h-8 md:h-10 mr-3 brightness-0 invert opacity-90 group-hover:opacity-100 transition-opacity">
                    <div class="hidden md:flex flex-col leading-tight border-l border-white/10 pl-3 ml-2">
                        <span class="font-black text-white text-sm tracking-widest uppercase">Operations</span>
                        <span class="text-[10px] text-klm font-bold uppercase tracking-[0.2em]">Command Center</span>
                    </div>
                </div>

                <!-- Desktop Menu -->
                <div class="hidden lg:flex items-center space-x-8">
                    <button onclick="router('home')" class="nav-link text-slate-300 hover:text-white transition-colors text-sm font-medium py-2">Home</button>
                    <button onclick="router('booking')" class="nav-link text-slate-300 hover:text-white transition-colors text-sm font-medium py-2">Dispatch</button>
                    <button onclick="router('livemap')" class="nav-link text-slate-300 hover:text-white transition-colors text-sm font-medium py-2">Live Radar</button>
                    <button onclick="router('fleet')" class="nav-link text-slate-300 hover:text-white transition-colors text-sm font-medium py-2">Fleet</button>
                    <button onclick="router('routes')" class="nav-link text-slate-300 hover:text-white transition-colors text-sm font-medium py-2">Network</button>
                    <button onclick="router('news')" class="nav-link text-slate-300 hover:text-white transition-colors text-sm font-medium py-2">Intel</button>
                    <button onclick="router('partners')" class="nav-link text-slate-300 hover:text-white transition-colors text-sm font-medium py-2">Partners</button>
                    
                    <div class="h-6 w-px bg-white/10 mx-2"></div>

                    <button onclick="router('profile')" class="flex items-center gap-2 group">
                        <div class="w-8 h-8 rounded-full bg-slate-800 border border-white/10 flex items-center justify-center overflow-hidden group-hover:border-klm transition-colors">
                            <i id="nav-avatar-fallback" data-lucide="user" class="w-4 h-4 text-slate-400 group-hover:text-klm transition-colors"></i>
                            <img id="nav-avatar-img" src="" class="w-full h-full object-cover hidden">
                        </div>
                        <span id="nav-username" class="text-sm font-medium text-slate-300 group-hover:text-white transition-colors">Pilot Login</span>
                    </button>
                </div>

                <div class="lg:hidden flex items-center">
                    <button onclick="toggleMobileMenu()" class="text-slate-300 hover:text-white focus:outline-none p-2">
                        <i data-lucide="menu" class="h-6 w-6"></i>
                    </button>
                </div>
            </div>
        </div>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden lg:hidden glass-nav absolute w-full left-0 z-40 border-b border-white/5">
            <div class="p-4 space-y-1">
                <button onclick="router('home'); toggleMobileMenu()" class="block w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 font-medium text-white">Home</button>
                <button onclick="router('profile'); toggleMobileMenu()" class="block w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 font-medium text-klm">Pilot Profile</button>
                <button onclick="router('booking'); toggleMobileMenu()" class="block w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 font-medium text-slate-300">Dispatch</button>
                <button onclick="router('livemap'); toggleMobileMenu()" class="block w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 font-medium text-slate-300">Live Radar</button>
                <button onclick="router('fleet'); toggleMobileMenu()" class="block w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 font-medium text-slate-300">Fleet</button>
                <button onclick="router('routes'); toggleMobileMenu()" class="block w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 font-medium text-slate-300">Network</button>
                <button onclick="router('news'); toggleMobileMenu()" class="block w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 font-medium text-slate-300">Intel</button>
                <button onclick="router('partners'); toggleMobileMenu()" class="block w-full text-left px-4 py-3 rounded-lg hover:bg-white/5 font-medium text-slate-300">Partners</button>
            </div>
        </div>
    </nav>

    <main id="app-content" class="flex-grow w-full overflow-hidden"></main>

    <footer class="glass-nav py-12 border-t border-white/5 relative z-10 mt-auto">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-12 mb-8 border-b border-white/5 pb-12">
                <div class="col-span-1 md:col-span-2">
                    <img id="footer-logo" src="" alt="KLM Logo" class="h-8 mb-6 brightness-0 invert opacity-70">
                    <p class="text-sm leading-relaxed max-w-sm text-slate-400 font-light">
                        A non-profit virtual aviation community. Setting the standard for realism, discipline, and operational excellence.<br>
                        Not affiliated with KLM Royal Dutch Airlines.
                    </p>
                </div>
                <div>
                    <h4 class="text-white font-bold mb-6 uppercase text-xs tracking-[0.2em]">Flight Operations</h4>
                    <ul class="space-y-3 text-sm text-slate-400">
                        <li><button onclick="router('sop')" class="hover:text-klm transition-colors flex items-center gap-2"><i data-lucide="book-open" class="w-4 h-4"></i> SOP Documentation</button></li>
                        <li><button onclick="router('fleet')" class="hover:text-klm transition-colors flex items-center gap-2"><i data-lucide="plane" class="w-4 h-4"></i> Fleet Manifest</button></li>
                        <li><button onclick="router('routes')" class="hover:text-klm transition-colors flex items-center gap-2"><i data-lucide="globe" class="w-4 h-4"></i> Network Hub</button></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-white font-bold mb-6 uppercase text-xs tracking-[0.2em]">Command Staff</h4>
                    <ul class="space-y-3 text-sm font-mono text-slate-300">
                        <li class="flex justify-between items-center bg-white/5 px-3 py-2 rounded"><span>mileflight</span> <span class="text-[10px] text-klm uppercase">CEO</span></li>
                        <li class="flex justify-between items-center bg-white/5 px-3 py-2 rounded"><span>JustFrost</span> <span class="text-[10px] text-slate-400 uppercase">Chairman</span></li>
                        <li class="flex justify-between items-center bg-white/5 px-3 py-2 rounded"><span>Nihid9044</span> <span class="text-[10px] text-slate-400 uppercase">Chairman</span></li>
                    </ul>
                </div>
            </div>
            <div class="flex flex-col md:flex-row justify-between items-center text-xs text-slate-500 font-mono">
                <div>&copy; 2026 KLM Virtual Airline Operations.</div>
                <div class="flex gap-4 mt-4 md:mt-0">
                    <a href="https://discord.gg/vRzmhuEmBQ" target="_blank" class="hover:text-white transition-colors flex items-center gap-1"><i data-lucide="message-square" class="w-4 h-4"></i> COMMS</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Leaflet Script (Non-module) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- MAIN APP SCRIPT (MODULE) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, orderBy, query, limit, serverTimestamp, doc, updateDoc, increment, setDoc, getDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==========================================
        //  FIREBASE CONFIGURATION
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBNM1Xc7a64GIlOiBiwJ5hE9Ci6EK1lxuo",
            authDomain: "klm-dispatch.firebaseapp.com",
            projectId: "klm-dispatch",
            storageBucket: "klm-dispatch.firebasestorage.app",
            messagingSenderId: "805612664938",
            appId: "1:805612664938:web:7a794aaaa0c184dcf6f213"
        };
        
        const REQUIRED_GUILD_ID = "1432591913915125824"; 

        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase initialized");
        } catch (e) { console.error("Firebase Error:", e); }

        const siteImages = {
            logo: "https://upload.wikimedia.org/wikipedia/commons/c/c7/KLM_logo.svg",
            homeHero: "https://content.r9cdn.net/rimg/dimg/aa/3f/bf32fc29-al-KL-168342f6d92.jpg?width=1366&height=768&xhint=1075&yhint=770&crop=true"
        };
        
        let discordUser = null; 
        
        window.doLogout = () => {
            localStorage.removeItem('klm_discord_user');
            window.location.reload();
        };

        function checkDiscordAuth() {
            const fragment = new URLSearchParams(window.location.hash.slice(1));
            const accessToken = fragment.get('access_token');
            const tokenType = fragment.get('token_type');

            if (accessToken) {
                window.history.replaceState({}, document.title, window.location.pathname);
                fetch('https://discord.com/api/users/@me', { headers: { authorization: `${tokenType} ${accessToken}` } })
                .then(res => res.json())
                .then(user => {
                    return fetch('https://discord.com/api/users/@me/guilds', { headers: { authorization: `${tokenType} ${accessToken}` } })
                    .then(res => res.json())
                    .then(guilds => {
                        const isMember = Array.isArray(guilds) && guilds.some(g => g.id === REQUIRED_GUILD_ID);
                        const userData = { ...user, isMember: isMember };
                        localStorage.setItem('klm_discord_user', JSON.stringify(userData));
                        discordUser = userData;
                        updateNavUser();
                        if(document.getElementById('login-section')) initBookingPage(); 
                        if(document.getElementById('profile-content')) initProfile();
                    });
                }).catch(console.error);
            } else {
                const stored = localStorage.getItem('klm_discord_user');
                if (stored) {
                    discordUser = JSON.parse(stored);
                    updateNavUser();
                }
            }
        }

        function updateNavUser() {
            const fallback = document.getElementById('nav-avatar-fallback');
            const img = document.getElementById('nav-avatar-img');
            const name = document.getElementById('nav-username');
            
            if(discordUser) {
                fallback.classList.add('hidden');
                img.classList.remove('hidden');
                img.src = `https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png`;
                name.textContent = discordUser.username;
            } else {
                fallback.classList.remove('hidden');
                img.classList.add('hidden');
                name.textContent = "Pilot Login";
            }
        }
        
        checkDiscordAuth();

        const fleetData = [
            { type: "Embraer 190", icao: "E190", role: "Cityhopper", desc: "Short-haul, high-frequency ops for training and local connectivity.", status: "Active", count: 21, img: "https://upload.wikimedia.org/wikipedia/commons/c/c6/Berlin_Brandenburg_Airport_KLM_Cityhopper_Embraer_E195-E2_PH-NXC_%28DSC02878%29.jpg" },
            { type: "Embraer 195-E2", icao: "E295", role: "Cityhopper", desc: "Modern regional efficiency. High frequency European connections.", status: "Active", count: 25, img: "https://img.static-kl.com/transform/53cea398-7cff-4e3f-a7b1-496d4552fb10/" },
            { type: "Boeing 737-700 LTRP", icao: "B737", role: "Short Haul", desc: "Legacy workhorse receiving extended-life refurbishment.", status: "LTRP", count: 6, img: "https://upload.wikimedia.org/wikipedia/commons/thumb/3/34/KLM_Boeing_737-7K2_PH-BGT_MUC_2015_01.jpg/1280px-KLM_Boeing_737-7K2_PH-BGT_MUC_2015_01.jpg" },
            { type: "Boeing 737-800", icao: "B738", role: "Short Haul", desc: "Backbone of European operations. Gradual retirement scheduled.", status: "Phasing Out", count: 30, img: "https://upload.wikimedia.org/wikipedia/commons/1/18/KLM_Boeing_737-800_PH-BCD_%2826038861623%29.jpg" },
            { type: "Airbus A320neo", icao: "A20N", role: "Short Haul", desc: "Next-gen European core. Maximum efficiency and realism.", status: "Active", count: 9, img: "https://image.parool.nl/211007987/width/2480/impressie-van-een-airbus-a320-neo-in-de-kleuren-van-klm" },
            { type: "Airbus A321neo", icao: "A21N", role: "Short Haul", desc: "High-capacity European routes. Primary replacement for B737.", status: "Active", count: 22, img: "https://img.static-kl.com/transform/8806738a-a661-4934-a177-95adef39307d/" },
            { type: "Airbus A330-200", icao: "A332", role: "Medium Haul", desc: "Intercontinental connector. Scheduled for retirement.", status: "Phasing Out", count: 6, img: "https://cdn.flightsim.to/images/27/inibuilds-a330-300-klm-fleet-pack-55321-1735741086-uIy_G.jpg?width=1400" },
            { type: "Boeing 777-300ER LTRP", icao: "B77W", role: "Long Haul", desc: "Reinforced and refurbished for reliable service.", status: "LTRP", count: 3, img: "https://www.aerotime.aero/images/klm_boeing_777-300er_orange_pride_livery.jpg" },
            { type: "Boeing 787-9", icao: "B789", role: "Long Haul", desc: "The future of our long-haul operations. Elite flagship.", status: "Active", count: 13, img: "https://content.presspage.com/uploads/162/1920_25508202-10155250600310773-6357422191407278812-n.jpg" },
            { type: "Boeing 787-10", icao: "B78X", role: "Long Haul", desc: "High-capacity Dreamliner for premium long-haul routes.", status: "Active", count: 14, img: "https://content.presspage.com/uploads/162/1920_paulridderhof30jun196473-465547.jpg?10000" },
        ];

        const routeData = {
            "Europe": [ { city: "London Heathrow", code: "EGLL", out: "KL1006, KL1007, KL1008, KL1009, KL1010", in: "KL1001, KL1002, KL1003, KL1004, KL1005" }, { city: "Paris CDG", code: "LFPG", out: "KL1016, KL1017, KL1018, KL1019, KL1020", in: "KL1011, KL1012, KL1013, KL1014, KL1015" }, { city: "Berlin", code: "EDDB", out: "KL1026, KL1027, KL1028, KL1029, KL1030", in: "KL1021, KL1022, KL1023, KL1024, KL1025" }, { city: "Rome", code: "LIRF", out: "KL1036, KL1037, KL1038, KL1039, KL1040", in: "KL1031, KL1032, KL1033, KL1034, KL1035" }, { city: "Madrid", code: "LEMD", out: "KL1046, KL1047, KL1048, KL1049, KL1050", in: "KL1041, KL1042, KL1043, KL1044, KL1045" }, { city: "Vienna", code: "LOWW", out: "KL1056, KL1057, KL1058, KL1059, KL1060", in: "KL1051, KL1052, KL1053, KL1054, KL1055" }, { city: "Brussels", code: "EBBR", out: "KL1066, KL1067, KL1068, KL1069, KL1070", in: "KL1061, KL1062, KL1063, KL1064, KL1065" }, { city: "Zurich", code: "LSZH", out: "KL1076, KL1077, KL1078, KL1079, KL1080", in: "KL1071, KL1072, KL1073, KL1074, KL1075" }, { city: "Geneva", code: "LSGG", out: "KL1086, KL1087, KL1088, KL1089, KL1090", in: "KL1081, KL1082, KL1083, KL1084, KL1085" }, { city: "Stockholm", code: "ESSA", out: "KL1096, KL1097, KL1098, KL1099, KL1100", in: "KL1091, KL1092, KL1093, KL1094, KL1095" }, { city: "Copenhagen", code: "EKCH", out: "KL1106, KL1107, KL1108, KL1109, KL1110", in: "KL1101, KL1102, KL1103, KL1104, KL1105" }, { city: "Oslo", code: "ENGM", out: "KL1116, KL1117, KL1118, KL1119, KL1120", in: "KL1111, KL1112, KL1113, KL1114, KL1115" }, { city: "Helsinki", code: "EFHK", out: "KL1126, KL1127, KL1128, KL1129, KL1130", in: "KL1121, KL1122, KL1123, KL1124, KL1125" }, { city: "Riga", code: "EVRA", out: "KL1136, KL1137, KL1138, KL1139, KL1140", in: "KL1131, KL1132, KL1133, KL1134, KL1135" }, { city: "Tallinn", code: "EETN", out: "KL1146, KL1147, KL1148, KL1149, KL1150", in: "KL1141, KL1142, KL1143, KL1144, KL1145" }, { city: "Vilnius", code: "EYVI", out: "KL1156, KL1157, KL1158, KL1159, KL1160", in: "KL1151, KL1152, KL1153, KL1154, KL1155" }, { city: "Porto", code: "LPPR", out: "KL1166, KL1167, KL1168, KL1169, KL1170", in: "KL1161, KL1162, KL1163, KL1164, KL1165" }, { city: "Lisbon", code: "LPPT", out: "KL1176, KL1177, KL1178, KL1179, KL1180", in: "KL1171, KL1172, KL1173, KL1174, KL1175" }, { city: "Kraków", code: "EPKK", out: "KL1186, KL1187, KL1188, KL1189, KL1190", in: "KL1181, KL1182, KL1183, KL1184, KL1185" }, { city: "Warsaw", code: "EPWA", out: "KL1196, KL1197, KL1198, KL1199, KL1200", in: "KL1191, KL1192, KL1193, KL1194, KL1195" }, { city: "Prague", code: "LKPR", out: "KL1206, KL1207, KL1208, KL1209, KL1210", in: "KL1201, KL1202, KL1203, KL1204, KL1205" }, { city: "Budapest", code: "LHBP", out: "KL1216, KL1217, KL1218, KL1219, KL1220", in: "KL1211, KL1212, KL1213, KL1214, KL1215" }, { city: "Bucharest", code: "LROP", out: "KL1226, KL1227, KL1228, KL1229, KL1230", in: "KL1221, KL1222, KL1223, KL1224, KL1225" }, { city: "Marseille", code: "LFML", out: "KL1236, KL1237, KL1238, KL1239, KL1240", in: "KL1231, KL1232, KL1233, KL1234, KL1235" }, { city: "Nice", code: "LFMN", out: "KL1246, KL1247, KL1248, KL1249, KL1250", in: "KL1241, KL1242, KL1243, KL1244, KL1245" }, { city: "Athens", code: "LGAV", out: "KL1256, KL1257, KL1258, KL1259, KL1260", in: "KL1251, KL1252, KL1253, KL1254, KL1255" } ],
            "North America": [ { city: "New York JFK", code: "KJFK", out: "KL2006, KL2007, KL2008, KL2009, KL2010", in: "KL2001, KL2002, KL2003, KL2004, KL2005" }, { city: "Atlanta", code: "KATL", out: "KL2016, KL2017, KL2018, KL2019, KL2020", in: "KL2011, KL2012, KL2013, KL2014, KL2015" }, { city: "Los Angeles", code: "KLAX", out: "KL2026, KL2027, KL2028, KL2029, KL2030", in: "KL2021, KL2022, KL2023, KL2024, KL2025" }, { city: "San Francisco", code: "KSFO", out: "KL2036, KL2037, KL2038, KL2039, KL2040", in: "KL2031, KL2032, KL2033, KL2034, KL2035" }, { city: "Chicago", code: "KORD", out: "KL2046, KL2047, KL2048, KL2049, KL2050", in: "KL2041, KL2042, KL2043, KL2044, KL2045" }, { city: "Washington", code: "KIAD", out: "KL2056, KL2057, KL2058, KL2059, KL2060", in: "KL2051, KL2052, KL2053, KL2054, KL2055" }, { city: "Boston", code: "KBOS", out: "KL2066, KL2067, KL2068, KL2069, KL2070", in: "KL2061, KL2062, KL2063, KL2064, KL2065" }, { city: "Houston", code: "KIAH", out: "KL2076, KL2077, KL2078, KL2079, KL2080", in: "KL2071, KL2072, KL2073, KL2074, KL2075" }, { city: "Toronto", code: "CYYZ", out: "KL2086, KL2087, KL2088, KL2089, KL2090", in: "KL2081, KL2082, KL2083, KL2084, KL2085" }, { city: "Montreal", code: "CYUL", out: "KL2096, KL2097, KL2098, KL2099, KL2100", in: "KL2091, KL2092, KL2093, KL2094, KL2095" }, { city: "Calgary", code: "CYYC", out: "KL2106, KL2107, KL2108, KL2109, KL2110", in: "KL2101, KL2102, KL2103, KL2104, KL2105" }, { city: "Vancouver", code: "CYVR", out: "KL2116, KL2117, KL2118, KL2119, KL2120", in: "KL2111, KL2112, KL2113, KL2114, KL2115" }, { city: "Mexico City", code: "MMMX", out: "KL2126, KL2127, KL2128, KL2129, KL2130", in: "KL2121, KL2122, KL2123, KL2124, KL2125" } ],
             "South America": [ { city: "São Paulo", code: "SBGR", out: "KL3006, KL3007, KL3008, KL3009, KL3010", in: "KL3001, KL3002, KL3003, KL3004, KL3005" }, { city: "Rio de Janeiro", code: "SBGL", out: "KL3016, KL3017, KL3018, KL3019, KL3020", in: "KL3011, KL3012, KL3013, KL3014, KL3015" }, { city: "Buenos Aires", code: "SAEZ", out: "KL3026, KL3027, KL3028, KL3029, KL3030", in: "KL3021, KL3022, KL3023, KL3024, KL3025" }, { city: "Lima", code: "SPJC", out: "KL3036, KL3037, KL3038, KL3039, KL3040", in: "KL3031, KL3032, KL3033, KL3034, KL3035" }, { city: "Bogotá", code: "SKBO", out: "KL3046, KL3047, KL3048, KL3049, KL3050", in: "KL3041, KL3042, KL3043, KL3044, KL3045" }, { city: "Quito", code: "SEQM", out: "KL3056, KL3057, KL3058, KL3059, KL3060", in: "KL3051, KL3052, KL3053, KL3054, KL3055" }, { city: "Guayaquil", code: "SEGU", out: "KL3066, KL3067, KL3068, KL3069, KL3070", in: "KL3061, KL3062, KL3063, KL3064, KL3065" }, { city: "Paramaribo", code: "SMJP", out: "KL3076, KL3077, KL3078, KL3079, KL3080", in: "KL3071, KL3072, KL3073, KL3074, KL3075" }, { city: "Aruba", code: "TNCA", out: "KL3086, KL3087, KL3088, KL3089, KL3090", in: "KL3081, KL3082, KL3083, KL3084, KL3085" }, { city: "Curaçao", code: "TNCC", out: "KL3096, KL3097, KL3098, KL3099, KL3100", in: "KL3091, KL3092, KL3093, KL3094, KL3095" }, { city: "Bonaire", code: "TNCB", out: "KL3106, KL3107, KL3108, KL3109, KL3110", in: "KL3101, KL3102, KL3103, KL3104, KL3105" }, { city: "St. Maarten", code: "TNCM", out: "KL3116, KL3117, KL3118, KL3119, KL3120", in: "KL3111, KL3112, KL3113, KL3114, KL3115" } ],
            "Africa": [ { city: "Nairobi", code: "HKJK", out: "KL4006, KL4007, KL4008, KL4009, KL4010", in: "KL4001, KL4002, KL4003, KL4004, KL4005" }, { city: "Dar es Salaam", code: "HTDA", out: "KL4016, KL4017, KL4018, KL4019, KL4020", in: "KL4011, KL4012, KL4013, KL4014, KL4015" }, { city: "Johannesburg", code: "FAOR", out: "KL4026, KL4027, KL4028, KL4029, KL4030", in: "KL4021, KL4022, KL4023, KL4024, KL4025" }, { city: "Cape Town", code: "FACT", out: "KL4036, KL4037, KL4038, KL4039, KL4040", in: "KL4031, KL4032, KL4033, KL4034, KL4035" }, { city: "Accra", code: "DGAA", out: "KL4046, KL4047, KL4048, KL4049, KL4050", in: "KL4041, KL4042, KL4043, KL4044, KL4045" }, { city: "Lagos", code: "DNMM", out: "KL4056, KL4057, KL4058, KL4059, KL4060", in: "KL4051, KL4052, KL4053, KL4054, KL4055" }, { city: "Kigali", code: "HRYR", out: "KL4066, KL4067, KL4068, KL4069, KL4070", in: "KL4061, KL4062, KL4063, KL4064, KL4065" }, { city: "Entebbe", code: "HUEN", out: "KL4076, KL4077, KL4078, KL4079, KL4080", in: "KL4071, KL4072, KL4073, KL4074, KL4075" } ],
            "Asia": [ { city: "Delhi", code: "VIDP", out: "KL5006, KL5007, KL5008, KL5009, KL5010", in: "KL5001, KL5002, KL5003, KL5004, KL5005" }, { city: "Mumbai", code: "VABB", out: "KL5016, KL5017, KL5018, KL5019, KL5020", in: "KL5011, KL5012, KL5013, KL5014, KL5015" }, { city: "Bangalore", code: "VOBL", out: "KL5026, KL5027, KL5028, KL5029, KL5030", in: "KL5021, KL5022, KL5023, KL5024, KL5025" }, { city: "Beijing", code: "ZBAA", out: "KL5036, KL5037, KL5038, KL5039, KL5040", in: "KL5031, KL5032, KL5033, KL5034, KL5035" }, { city: "Shanghai", code: "ZSPD", out: "KL5046, KL5047, KL5048, KL5049, KL5050", in: "KL5041, KL5042, KL5043, KL5044, KL5045" }, { city: "Hong Kong", code: "VHHH", out: "KL5056, KL5057, KL5058, KL5059, KL5060", in: "KL5051, KL5052, KL5053, KL5054, KL5055" }, { city: "Tokyo Narita", code: "RJAA", out: "KL5066, KL5067, KL5068, KL5069, KL5070", in: "KL5061, KL5062, KL5063, KL5064, KL5065" }, { city: "Osaka Kansai", code: "RJBB", out: "KL5076, KL5077, KL5078, KL5079, KL5080", in: "KL5071, KL5072, KL5073, KL5074, KL5075" }, { city: "Seoul Incheon", code: "RKSI", out: "KL5086, KL5087, KL5088, KL5089, KL5090", in: "KL5081, KL5082, KL5083, KL5084, KL5085" }, { city: "Bangkok", code: "VTBS", out: "KL5096, KL5097, KL5098, KL5099, KL5100", in: "KL5091, KL5092, KL5093, KL5094, KL5095" }, { city: "Singapore", code: "WSSS", out: "KL5106, KL5107, KL5108, KL5109, KL5110", in: "KL5101, KL5102, KL5103, KL5104, KL5105" }, { city: "Kuala Lumpur", code: "WMKK", out: "KL5116, KL5117, KL5118, KL5119, KL5120", in: "KL5111, KL5112, KL5113, KL5114, KL5115" }, { city: "Jakarta", code: "WIII", out: "KL5126, KL5127, KL5128, KL5129, KL5130", in: "KL5121, KL5122, KL5123, KL5124, KL5125" }, { city: "Manila", code: "RPLL", out: "KL5136, KL5137, KL5138, KL5139, KL5140", in: "KL5131, KL5132, KL5133, KL5134, KL5135" }, { city: "Taipei", code: "RCTP", out: "KL5146, KL5147, KL5148, KL5149, KL5150", in: "KL5141, KL5142, KL5143, KL5144, KL5145" }, { city: "Denpasar Bali", code: "WADD", out: "KL5156, KL5157, KL5158, KL5159, KL5160", in: "KL5151, KL5152, KL5153, KL5154, KL5155" } ],
            "Middle East": [ { city: "Dubai", code: "OMDB", out: "KL6006, KL6007, KL6008, KL6009, KL6010", in: "KL6001, KL6002, KL6003, KL6004, KL6005" }, { city: "Abu Dhabi", code: "OMAA", out: "KL6016, KL6017, KL6018, KL6019, KL6020", in: "KL6011, KL6012, KL6013, KL6014, KL6015" }, { city: "Kuwait City", code: "OKBK", out: "KL6026, KL6027, KL6028, KL6029, KL6030", in: "KL6021, KL6022, KL6023, KL6024, KL6025" }, { city: "Doha", code: "OTHH", out: "KL6036, KL6037, KL6038, KL6039, KL6040", in: "KL6031, KL6032, KL6033, KL6034, KL6035" }, { city: "Tel Aviv", code: "LLBG", out: "KL6046, KL6047, KL6048, KL6049, KL6050", in: "KL6041, KL6042, KL6043, KL6044, KL6045" }, { city: "Riyadh", code: "OERK", out: "KL6056, KL6057, KL6058, KL6059, KL6060", in: "KL6051, KL6052, KL6053, KL6054, KL6055" }, { city: "Cairo", code: "HECA", out: "KL6066, KL6067, KL6068, KL6069, KL6070", in: "KL6061, KL6062, KL6063, KL6064, KL6065" } ]
        };

        const newsData = [
            { date: "18 FEB 2026", title: "Departure from SkyLink Global Alliance", tag: "PARTNERSHIP", content: "Due to concerns about admin abuse, KLM has decided to leave SkyLink Global. As the Chairman of KLM my responsibility is to ensure a safe environment for my pilots, which clearly cannot be maintained in SLG. This underscores that leadership and moderation standards matter and the highest priority is to always uphold the values and trust which GCRP stands for.<br><br><span class='font-mono text-klm uppercase text-xs'>Signed, Office of the Chairman [KLM]</span>" },
            { date: "15 FEB 2026", title: "Flight Number and Systems Update", tag: "TECH", content: "New flight numbers have been issued across the network, accompanied by website and bot updates to support ongoing restructuring and operational improvements." },
            { date: "11 FEB 2026", title: "Callsign Standardization Directive", tag: "OPS", content: "All pilots are required to use the callsign “KL” instead of “KLM” when operating on RadarThing to ensure standardization and realism across network operations." },
            { date: "08 FEB 2026", title: "Official Statement on Flight KLM1016 Accident", tag: "URGENT", content: "KLM Virtual Airlines confirms that Flight KLM1016, operated by an Embraer 190 from Amsterdam to London Heathrow, was involved in a fatal accident shortly after departure, resulting in the loss of all passengers and crew. We are cooperating fully with GASA investigators, preserving operational data, and conducting an immediate internal safety review." },
            { date: "01 FEB 2026", title: "Long-Term Refurbishment Plan (LTRP)", tag: "FLEET", content: "We are launching the Long-Term Refurbishment Plan with a $65 million investment in remaining Boeing 737-7 and 777-300ER aircraft to extend service life. The Airbus A330-200 will be fully phased out as part of this strategy." },
            { date: "23 JAN 2026", title: "Widebody Qualification System Update", tag: "STAFF", content: "We are reworking the pilot ranking and qualification system. Widebody aircraft operations are temporarily restricted to senior staff, with certification available to pilots who meet minimum flight hour requirements." },
            { date: "20 JAN 2026", title: "Website v3.0 Launch", tag: "TECH", content: "Our redesigned KLM Virtual Airlines website v3.0 is now live, featuring real-time pilot tracking, updated fleet and route information, SOP documentation, and partner integrations. This platform reinforces our operations-first identity and professional pilot culture." },
            { date: "16 JAN 2026", title: "Middle East Airspace Restrictions", tag: "ALERT", content: "Due to escalating regional tensions, KLM Virtual Airlines has implemented mandatory restrictions on Iraqi, Iranian, and Qatari airspace. Pilots must manually adjust flight plans to avoid restricted FIRs, with Saudi corridors permitted as an exception." },
            { date: "26 DEC 2025", title: "Launch of KLM Asia Subsidiary", tag: "FLEET", content: "We are launching KLM Asia, a subsidiary operating three Boeing 787-9 aircraft to maintain Taiwan operations without geopolitical restrictions. KLM Asia will operate under dedicated branding while remaining fully integrated into KLM Virtual Airlines operations." },
            { date: "17 DEC 2025", title: "GASA Safety Certification", tag: "SAFETY", content: "We are proud to announce that KLM Virtual Airlines has been certified by the GeoFS Aviation Safety Authority (GASA). This certification establishes independent investigation procedures and formal safety oversight for all airline operations." },
            { date: "28 OCT 2025", title: "Launch of KLM Virtual Airlines Operations", tag: "LAUNCH", content: "We are pleased to announce that the KLM Virtual Airlines server infrastructure has been completed and is now fully operational. With this launch, pilots and staff can begin structured operations, route logging, and community development under the KLM Virtual Airlines framework." }
        ];

        function getTagColor(tag) {
            const colors = {
                'URGENT': 'border-red-500 text-red-400 bg-red-900/20',
                'ALERT': 'border-red-500 text-red-400 bg-red-900/20',
                'OPS': 'border-amber-500 text-amber-400 bg-amber-900/20',
                'DISPATCH': 'border-amber-500 text-amber-400 bg-amber-900/20',
                'FLEET': 'border-blue-500 text-blue-400 bg-blue-900/20',
                'TECH': 'border-cyan-500 text-cyan-400 bg-cyan-900/20',
                'STAFF': 'border-purple-500 text-purple-400 bg-purple-900/20',
                'PARTNERSHIP': 'border-teal-500 text-teal-400 bg-teal-900/20',
                'SAFETY': 'border-emerald-500 text-emerald-400 bg-emerald-900/20',
                'LAUNCH': 'border-klm text-klm bg-klm/10'
            };
            return colors[tag] || 'border-slate-500 text-slate-300 bg-slate-800/50';
        }

        const pages = {
            home: `
                <div class="relative min-h-[90vh] flex flex-col pt-10">
                    <div class="absolute inset-0 z-0">
                        <img src="${siteImages.homeHero}" class="w-full h-full object-cover opacity-40 mix-blend-luminosity" alt="KLM Ops">
                        <div class="absolute inset-0 bg-gradient-to-t from-slate-950 via-slate-950/80 to-transparent"></div>
                    </div>
                    
                    <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-24 flex-grow flex flex-col justify-center animate-slide-up">
                        <h1 class="text-6xl md:text-8xl font-black tracking-tighter mb-6 leading-none text-white drop-shadow-2xl">
                            Flying the World, <br><span class="text-gradient-klm glow-klm">Virtually.</span>
                        </h1>
                        <p class="text-xl text-slate-300 mb-12 max-w-2xl font-light leading-relaxed">
                            A highly disciplined, operations-first simulation community. We enforce strict procedures, realistic dispatching, and elite standards.
                        </p>
                        
                        <!-- LIVE DISPATCH BOARD -->
                        <div class="mt-8 animate-slide-up delay-200">
                            <div class="flex justify-between items-end mb-4 max-w-5xl">
                                <h3 class="text-xl font-bold flex items-center text-white">
                                    <i data-lucide="radar" class="w-5 h-5 mr-3 text-klm"></i> 
                                    Live Dispatch Operations
                                </h3>
                                <div class="flex items-center gap-2 bg-slate-900/80 border border-white/10 px-3 py-1.5 rounded-full backdrop-blur-md">
                                    <div id="db-status-light" class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                                    <span id="db-status-text" class="text-[10px] font-mono font-bold text-slate-400 uppercase tracking-widest">Awaiting Sync</span>
                                </div>
                            </div>
                            
                            <div class="fids-board max-w-5xl">
                                <div class="fids-header">
                                    <div>Callsign</div>
                                    <div>Flight</div>
                                    <div>Date</div>
                                    <div class="hidden md:block">Route</div>
                                    <div>Equipment</div>
                                    <div class="text-right">Status</div>
                                </div>
                                <div id="dispatch-rows" class="bg-black/20">
                                    <div class="p-8 text-center text-slate-500 flex flex-col items-center">
                                        <i data-lucide="loader" class="w-6 h-6 animate-spin mb-3 opacity-50"></i>
                                        Connecting to Central Server...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `,

            profile: `
                <div class="relative max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-24 animate-fade-in min-h-[80vh]">
                    
                    <!-- Login Prompt -->
                    <div id="profile-login-prompt" class="hidden text-center mt-20 animate-slide-up">
                        <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-[#5865F2]/10 mb-6">
                            <i data-lucide="shield" class="w-10 h-10 text-[#5865F2]"></i>
                        </div>
                        <h2 class="text-4xl font-black text-white mb-4">Pilot Authentication Required</h2>
                        <p class="text-slate-400 max-w-lg mx-auto mb-8">Secure access to the operations dashboard requires active verification of your KLM VA server membership via Discord.</p>
                        
                        <a href="https://discord.com/oauth2/authorize?client_id=1464272995542634566&response_type=token&redirect_uri=https%3A%2F%2Fklmgeofsvirtual.github.io%2Fklm-virtual-airline%2F&scope=identify+guilds" 
                           class="inline-flex items-center justify-center bg-[#5865F2] hover:bg-[#4752C4] text-white font-bold py-4 px-8 rounded-xl transition-all shadow-lg shadow-[#5865F2]/20 hover:scale-105">
                            <svg class="w-5 h-5 mr-3 fill-current" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037 20.818 20.818 0 0 0-3.361 6.91 20.8 20.8 0 0 0-3.356-6.91.071.071 0 0 0-.077-.037 19.782 19.782 0 0 0-4.886 1.515.072.072 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.086 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.086 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>
                            Authenticate via Discord
                        </a>
                    </div>

                    <!-- Dashboard Content -->
                    <div id="profile-content" class="hidden">
                        <div class="flex flex-col md:flex-row items-center md:items-start gap-8 glass-panel p-8 md:p-10 rounded-3xl mb-8 animate-slide-up">
                            <div class="relative">
                                <img id="profile-avatar" src="" class="w-32 h-32 rounded-full ring-4 ring-klm/50 shadow-[0_0_30px_rgba(0,161,222,0.3)] object-cover bg-slate-800">
                                <div class="absolute bottom-0 right-0 w-8 h-8 bg-emerald-500 border-4 border-[#020617] rounded-full"></div>
                            </div>
                            <div class="text-center md:text-left flex-grow">
                                <h1 id="profile-name" class="text-4xl md:text-5xl font-black text-white tracking-tight"></h1>
                                <div class="flex flex-wrap justify-center md:justify-start gap-3 mt-4">
                                    <span class="px-3 py-1 bg-klm/10 border border-klm/30 text-klm text-xs font-bold uppercase tracking-widest rounded-full">Active Pilot</span>
                                    <span class="px-3 py-1 bg-white/5 border border-white/10 text-slate-300 text-xs font-bold uppercase tracking-widest rounded-full font-mono">ID: <span id="profile-id">---</span></span>
                                </div>
                            </div>
                            <div class="mt-4 md:mt-0">
                                <button onclick="window.doLogout()" class="px-6 py-2 border border-red-500/30 text-red-400 hover:bg-red-500/10 rounded-lg text-sm font-bold uppercase tracking-wider transition-colors">Log Out</button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="glass-panel p-8 rounded-3xl text-center animate-slide-up delay-100">
                                <i data-lucide="plane-takeoff" class="w-8 h-8 text-slate-500 mx-auto mb-4"></i>
                                <div class="text-slate-400 text-xs font-bold uppercase tracking-[0.2em] mb-2">Total Dispatches</div>
                                <div id="stat-booked" class="text-5xl font-black text-white">--</div>
                            </div>
                            <div class="glass-panel p-8 rounded-3xl text-center animate-slide-up delay-200 border-t-2 border-t-klm relative overflow-hidden">
                                <div class="absolute inset-0 bg-klm/5 pointer-events-none"></div>
                                <i data-lucide="check-circle" class="w-8 h-8 text-klm mx-auto mb-4"></i>
                                <div class="text-klm text-xs font-bold uppercase tracking-[0.2em] mb-2">Flights Completed</div>
                                <div id="stat-completed" class="text-5xl font-black text-white drop-shadow-[0_0_15px_rgba(0,161,222,0.5)]">--</div>
                            </div>
                            <div class="glass-panel p-8 rounded-3xl text-center animate-slide-up delay-300">
                                <i data-lucide="award" class="w-8 h-8 text-amber-500 mx-auto mb-4"></i>
                                <div class="text-slate-400 text-xs font-bold uppercase tracking-[0.2em] mb-2">Assigned Rank</div>
                                <div id="stat-rank" class="text-2xl font-black text-white mt-4">--</div>
                                <div class="w-full bg-slate-800 h-1.5 rounded-full mt-4 overflow-hidden">
                                    <div id="rank-progress" class="bg-amber-500 h-full w-0 transition-all duration-1000"></div>
                                </div>
                            </div>
                        </div>

                        <div class="glass-panel p-8 rounded-3xl animate-slide-up delay-300">
                            <div class="flex justify-between items-center border-b border-white/5 pb-4 mb-6">
                                <h3 class="text-xl font-bold text-white flex items-center gap-3"><i data-lucide="book" class="text-klm"></i> Recent Logbook</h3>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left border-collapse">
                                    <thead>
                                        <tr class="text-slate-500 text-xs uppercase tracking-wider font-mono border-b border-white/5">
                                            <th class="pb-3 px-4 font-normal">Date (Z)</th>
                                            <th class="pb-3 px-4 font-normal">Flight</th>
                                            <th class="pb-3 px-4 font-normal">Routing</th>
                                            <th class="pb-3 px-4 font-normal">Equipment</th>
                                            <th class="pb-3 px-4 font-normal text-right">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="profile-logbook-table" class="text-sm">
                                        <tr><td colspan="5" class="py-8 text-center text-slate-500"><i data-lucide="loader" class="w-5 h-5 animate-spin mx-auto mb-2"></i> Syncing records...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `,
            
            condolences: `
                <div class="relative min-h-[80vh] flex flex-col justify-center py-24 animate-fade-in">
                    <!-- Subtle memorial background -->
                    <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-900 via-[#020617] to-[#020617] -z-10"></div>
                    
                    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 w-full">
                        <div class="text-center mb-12">
                            <img src="${siteImages.logo}" class="h-12 mx-auto mb-8 filter grayscale opacity-40">
                            <h1 class="text-3xl md:text-5xl font-serif text-slate-300 mb-4 tracking-wide">In Memoriam</h1>
                            <div class="w-16 h-px bg-slate-700 mx-auto my-6"></div>
                            <p class="text-slate-500 uppercase tracking-[0.3em] text-xs font-bold">Flight KLM1016 • 23 JAN 2026</p>
                        </div>

                        <div class="glass-panel border-t-2 border-t-slate-700 p-8 md:p-12 rounded-3xl mb-12 relative overflow-hidden text-center">
                             <div class="prose prose-invert prose-lg mx-auto text-slate-400 leading-relaxed font-light">
                                <p>KLM Virtual Airlines confirms the tragic loss of Flight KLM1016, operating from Amsterdam Schiphol to London Heathrow.</p>
                                <p>Our deepest condolences go out to the families, friends, and colleagues of the 94 passengers and crew aboard. We are fully cooperating with the Global Aviation Safety Authority (GASA) to ensure a comprehensive investigation.</p>
                                <div class="mt-8 text-sm italic text-slate-600">This memorial refers to virtual operations and is not affiliated with real-world airlines.</div>
                             </div>

                             <div class="mt-16 text-center">
                                <button id="condolence-btn" onclick="window.submitCondolence()" class="group relative inline-flex items-center justify-center px-8 py-3 text-sm font-medium text-slate-300 bg-white/5 border border-white/10 rounded-full hover:bg-white/10 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed hover-lift">
                                    <i data-lucide="flower-2" class="w-4 h-4 mr-3 text-slate-500 group-hover:text-white transition-colors"></i>
                                    <span id="condolence-btn-text" class="tracking-widest uppercase">Pay Respects</span>
                                </button>
                                <div class="mt-6 flex items-center justify-center gap-3 text-xs text-slate-500 font-mono tracking-widest uppercase">
                                    <span id="condolence-count" class="text-white font-bold text-lg tabular-nums">---</span>
                                    <span>Tributes Paid</span>
                                </div>
                             </div>
                        </div>
                        
                        <div class="text-center">
                            <button onclick="router('news')" class="text-slate-600 hover:text-white transition-colors text-xs font-bold uppercase tracking-widest"><i data-lucide="arrow-left" class="w-3 h-3 inline mr-1"></i> Return to Archives</button>
                        </div>
                    </div>
                </div>
            `,

            news: `
                <div class="relative py-24 animate-fade-in">
                    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                        
                        <!-- Memorial Link Card -->
                        <div class="glass-panel border-l-4 border-slate-600 rounded-2xl p-6 mb-16 cursor-pointer hover:bg-white/5 transition-colors group animate-slide-up" onclick="router('condolences')">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <div class="w-2 h-2 rounded-full bg-slate-500"></div>
                                        <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Official Memorial</span>
                                    </div>
                                    <h3 class="text-lg font-bold text-slate-200 group-hover:text-white transition-colors">In Memoriam: Flight KLM1016</h3>
                                </div>
                                <i data-lucide="arrow-right" class="text-slate-600 group-hover:text-slate-300 transition-colors"></i>
                            </div>
                        </div>

                        <div class="mb-12 animate-slide-up delay-100">
                            <h1 class="text-4xl font-black text-white mb-4">Operations Intel</h1>
                            <p class="text-slate-400">Chronological record of official directives, fleet changes, and operational notices.</p>
                        </div>
                        
                        <div class="space-y-6">
                            ${newsData.map((news, i) => {
                                const colorClass = getTagColor(news.tag);
                                const delay = 100 + (Math.min(i, 5) * 100);
                                return `
                                <article class="glass-panel rounded-2xl p-6 border-l-2 ${colorClass.split(' ')[0]} animate-slide-up" style="animation-delay: ${delay}ms;">
                                    <div class="flex items-center gap-3 mb-4 text-[10px] font-mono uppercase tracking-widest">
                                        <span class="font-bold px-2.5 py-1 rounded-sm border ${colorClass}">${news.tag}</span>
                                        <span class="text-slate-500">${news.date}</span>
                                    </div>
                                    <h2 class="text-xl font-bold text-slate-100 mb-3 leading-snug">${news.title}</h2>
                                    <div class="text-slate-400 leading-relaxed text-sm font-light">
                                        ${news.content}
                                    </div>
                                </article>
                            `}).join('')}
                        </div>
                    </div>
                </div>
            `,

            fleet: `
                <div class="relative py-24 animate-fade-in">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="text-center mb-16 animate-slide-up">
                            <h1 class="text-4xl font-black text-white mb-4">Fleet Allocation</h1>
                            <p class="text-slate-400 max-w-2xl mx-auto font-light">Strategic deployment of modern, efficient aircraft designed for rigorous scheduling.</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            ${fleetData.map((plane, i) => {
                                let statusColor = plane.status === 'Active' ? 'text-emerald-400 border-emerald-500/30 bg-emerald-500/10' : 
                                                  plane.status === 'Phasing Out' ? 'text-amber-400 border-amber-500/30 bg-amber-500/10' : 
                                                  plane.status === 'LTRP' ? 'text-purple-400 border-purple-500/30 bg-purple-500/10' :
                                                  'text-indigo-400 border-indigo-500/30 bg-indigo-500/10';
                                return `
                                <div class="glass-panel rounded-2xl overflow-hidden hover-lift group animate-slide-up" style="animation-delay: ${i*50}ms;">
                                    <div class="h-48 overflow-hidden relative bg-slate-900 border-b border-white/5">
                                        <img src="${plane.img}" class="w-full h-full object-cover opacity-60 group-hover:opacity-100 group-hover:scale-110 transition duration-700 mix-blend-luminosity group-hover:mix-blend-normal" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/thumb/a/ac/No_image_available.svg/1024px-No_image_available.svg.png'">
                                        <div class="absolute inset-0 bg-gradient-to-t from-[#020617] via-transparent to-transparent"></div>
                                        <div class="absolute top-4 right-4 ${statusColor} border px-2.5 py-1 rounded text-[10px] font-bold uppercase tracking-widest backdrop-blur-md shadow-sm">
                                            ${plane.status}
                                        </div>
                                    </div>
                                    <div class="p-6 relative z-20">
                                        <div class="flex justify-between items-baseline mb-2">
                                            <h3 class="text-lg font-bold text-white tracking-tight">${plane.type}</h3>
                                            <span class="text-slate-500 text-xs font-mono font-bold">QTY: ${plane.count}</span>
                                        </div>
                                        <div class="text-klm text-[10px] font-bold uppercase tracking-widest mb-4 flex items-center gap-2">
                                            <i data-lucide="plane" class="w-3 h-3"></i> ${plane.role}
                                        </div>
                                        <div class="text-[10px] text-slate-400 font-mono mb-4 bg-white/5 border border-white/5 inline-block px-2 py-1 rounded">ICAO: ${plane.icao}</div>
                                        <p class="text-slate-400 text-sm leading-relaxed font-light">${plane.desc}</p>
                                    </div>
                                </div>
                                `
                            }).join('')}
                        </div>
                    </div>
                </div>
            `,

            booking: `
                <div class="relative py-24 animate-fade-in">
                    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="mb-12 animate-slide-up">
                            <h1 class="text-4xl font-black text-white mb-2">Flight Dispatch</h1>
                            <p class="text-slate-400 font-light">File your operational flight plan and secure board slot.</p>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="lg:col-span-2 glass-panel p-8 rounded-3xl animate-slide-up delay-100">
                                <form id="booking-form" onsubmit="window.handleBookingSubmit(event)">
                                    
                                    <div class="mb-8 border-b border-white/5 pb-8">
                                        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-[0.2em] mb-6 flex items-center gap-2"><i data-lucide="shield-check" class="w-4 h-4 text-klm"></i> Security Clearance</h3>
                                        <div id="login-section"></div>
                                    </div>

                                    <div class="mb-8 border-b border-white/5 pb-8">
                                        <div class="flex items-center justify-between mb-6">
                                            <h3 class="text-xs font-bold text-slate-500 uppercase tracking-[0.2em] flex items-center gap-2"><i data-lucide="map" class="w-4 h-4 text-klm"></i> Routing</h3>
                                            <label class="flex items-center gap-2 cursor-pointer group">
                                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest group-hover:text-white transition">Charter Mode</span>
                                                <input type="checkbox" id="custom-route-toggle" onchange="window.toggleCustomRoute()" class="accent-klm w-4 h-4 rounded bg-white/10 border-white/20">
                                            </label>
                                        </div>

                                        <div id="standard-controls">
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                                <div>
                                                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Vector</label>
                                                    <div class="flex bg-slate-900/50 rounded-lg p-1 border border-white/5">
                                                        <button type="button" onclick="window.setDirection('out')" id="btn-out" class="flex-1 py-2 rounded-md font-bold text-xs uppercase tracking-wide bg-klm text-white shadow-lg transition-all">Outbound</button>
                                                        <button type="button" onclick="window.setDirection('in')" id="btn-in" class="flex-1 py-2 rounded-md font-bold text-xs uppercase tracking-wide text-slate-500 hover:text-white transition-all">Inbound</button>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Theater</label>
                                                    <select id="region-select" onchange="window.updateDestinations()" class="w-full sleek-input rounded-lg p-3 text-sm"></select>
                                                </div>
                                            </div>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                                <div>
                                                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Waypoint</label>
                                                    <select id="dest-select" onchange="window.updateFlightDetails()" class="w-full sleek-input rounded-lg p-3 text-sm"></select>
                                                </div>
                                                <div>
                                                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Callsign Identifier</label>
                                                    <select id="flight-select" onchange="window.updatePreview()" class="w-full sleek-input rounded-lg p-3 text-sm font-mono"></select>
                                                </div>
                                            </div>
                                        </div>

                                        <div id="custom-controls" class="hidden">
                                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                                <div>
                                                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">DEP ICAO</label>
                                                    <input type="text" id="custom-dep" placeholder="EHAM" maxlength="4" oninput="this.value = this.value.toUpperCase(); window.updatePreview()" class="w-full sleek-input rounded-lg p-3 text-sm font-mono uppercase">
                                                </div>
                                                <div>
                                                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">ARR ICAO</label>
                                                    <input type="text" id="custom-arr" placeholder="KJFK" maxlength="4" oninput="this.value = this.value.toUpperCase(); window.updatePreview()" class="w-full sleek-input rounded-lg p-3 text-sm font-mono uppercase">
                                                </div>
                                                <div>
                                                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Flight NO.</label>
                                                    <input type="text" id="custom-flight" placeholder="KL..." maxlength="7" oninput="this.value = this.value.toUpperCase(); window.updatePreview()" class="w-full sleek-input rounded-lg p-3 text-sm font-mono uppercase">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="bg-slate-900/80 rounded-xl p-4 flex justify-between items-center text-sm font-mono text-slate-400 border border-white/5">
                                            <div class="text-center w-24">
                                                <div class="text-[9px] uppercase tracking-widest text-slate-500 mb-1">Origin</div>
                                                <div id="disp-dep" class="font-bold text-2xl text-white">----</div>
                                            </div>
                                            <div class="flex-grow flex flex-col items-center px-4 relative">
                                                <div class="w-full h-px bg-slate-700 absolute top-1/2"></div>
                                                <i data-lucide="plane" class="w-5 h-5 text-klm relative z-10 bg-slate-900 px-1"></i>
                                            </div>
                                            <div class="text-center w-24">
                                                <div class="text-[9px] uppercase tracking-widest text-slate-500 mb-1">Dest</div>
                                                <div id="disp-arr" class="font-bold text-2xl text-white">----</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-8">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div>
                                                <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Equipment</label>
                                                <select id="aircraft-select" onchange="window.updatePreview()" class="w-full sleek-input rounded-lg p-3 text-sm"></select>
                                            </div>
                                            <div>
                                                <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">EOBT (Zulu)</label>
                                                <input type="time" id="dep-time" onchange="window.updatePreview()" required class="w-full sleek-input rounded-lg p-3 text-sm font-mono text-white">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-8 flex items-center justify-between bg-white/5 p-4 rounded-xl border border-white/5">
                                        <label class="flex items-center gap-3 cursor-pointer group">
                                            <div class="relative">
                                                <input type="checkbox" id="is-test-flight" class="sr-only peer">
                                                <div class="w-10 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-klm"></div>
                                            </div>
                                            <span class="text-sm font-bold text-slate-300 group-hover:text-white transition">Training / Test Run</span>
                                        </label>
                                    </div>

                                    <button type="submit" class="w-full bg-klm hover:bg-sky-400 text-white font-black uppercase tracking-widest py-4 rounded-xl shadow-[0_0_20px_rgba(0,161,222,0.4)] transition-all transform active:scale-95 flex justify-center items-center disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none disabled:bg-slate-700">
                                        <i data-lucide="send" class="w-5 h-5 mr-3"></i> Transmit Dispatch
                                    </button>

                                </form>
                            </div>

                            <div class="lg:col-span-1 animate-slide-up delay-200">
                                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-[0.2em] mb-4">Generated Strip</h3>
                                <div class="bg-slate-900 text-white p-6 rounded-2xl border border-white/10 shadow-2xl font-mono text-sm relative overflow-hidden">
                                    <div class="absolute left-0 top-0 bottom-0 w-2 bg-klm"></div>
                                    <div class="absolute -right-10 -top-10 text-white/5 rotate-12 pointer-events-none">
                                        <i data-lucide="plane" class="w-48 h-48"></i>
                                    </div>
                                    
                                    <div class="relative z-10 space-y-6 pl-4">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <div class="text-[9px] text-slate-500 tracking-widest uppercase mb-1">CALLSIGN</div>
                                                <div class="text-2xl font-black text-klm" id="preview-callsign">KLM---</div>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-[9px] text-slate-500 tracking-widest uppercase mb-1">ACFT</div>
                                                <div class="font-bold text-white" id="preview-ac">---</div>
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-4">
                                            <div class="bg-white/5 p-3 rounded-lg border border-white/5">
                                                <div class="text-[9px] text-slate-500 tracking-widest uppercase mb-1">ADEP</div>
                                                <div class="font-bold text-xl text-white" id="preview-dep">----</div>
                                            </div>
                                            <div class="bg-white/5 p-3 rounded-lg border border-white/5 text-right">
                                                <div class="text-[9px] text-slate-500 tracking-widest uppercase mb-1">ADES</div>
                                                <div class="font-bold text-xl text-white" id="preview-arr">----</div>
                                            </div>
                                        </div>

                                        <div class="border-t border-white/10 pt-4 flex justify-between items-end">
                                            <div>
                                                <div class="text-[9px] text-slate-500 tracking-widest uppercase mb-1">PIC</div>
                                                <div class="font-bold text-slate-300 truncate max-w-[120px]" id="preview-pilot">---</div>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-[9px] text-slate-500 tracking-widest uppercase mb-1">EOBT</div>
                                                <div class="font-black text-lg text-emerald-400" id="preview-time">--:--</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `,

            routes: `
                <div class="relative py-24 animate-fade-in">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex flex-col lg:flex-row gap-12 mb-12 animate-slide-up">
                            <div class="lg:w-1/3">
                                <h1 class="text-4xl font-black text-white mb-4">Global Network</h1>
                                <p class="text-slate-400 font-light leading-relaxed mb-8">
                                    Our structured route network stems from the hub at <strong>Amsterdam Airport Schiphol (EHAM)</strong>. 
                                    Destinations are meticulously curated to ensure operational realism matching current fleet capabilities.
                                </p>
                                <div class="glass-panel p-6 rounded-2xl border-l-4 border-klm">
                                    <div class="text-2xl font-black text-white mb-1">112</div>
                                    <div class="text-xs text-slate-400 font-bold uppercase tracking-widest">Active Destinations</div>
                                </div>
                            </div>
                            <div class="lg:w-2/3 relative h-[450px] bg-slate-900 rounded-3xl overflow-hidden border border-white/10 shadow-2xl glow-klm">
                                <div id="fleet-map"></div>
                            </div>
                        </div>

                        <div class="glass-panel rounded-2xl p-2 flex flex-wrap gap-2 mb-8 w-fit mx-auto lg:mx-0 animate-slide-up delay-100">
                            ${Object.keys(routeData).map(region => `
                                <button onclick="window.renderRouteGrid('${region}')" 
                                    class="route-btn px-6 py-2 rounded-xl text-xs font-bold uppercase tracking-widest transition-all focus:outline-none"
                                    id="btn-${region}">
                                    ${region}
                                </button>
                            `).join('')}
                        </div>
                        
                        <div id="route-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 animate-slide-up delay-200"></div>
                    </div>
                </div>
            `,

            livemap: `
                <div class="flex flex-col h-[calc(100vh-80px)] animate-fade-in">
                    <div class="glass-nav px-6 py-4 flex justify-between items-center border-b border-white/5 z-10">
                        <div>
                            <h1 class="text-lg font-black text-white flex items-center gap-3 uppercase tracking-widest">
                                <span class="w-2.5 h-2.5 rounded-full bg-red-500 animate-pulse shadow-[0_0_10px_rgba(239,68,68,0.8)]"></span> 
                                Live Radar
                            </h1>
                        </div>
                        <div class="text-xs text-slate-500 font-mono">Powered by RadarThing</div>
                    </div>
                    <div class="flex-grow bg-[#0f172a] relative">
                        <iframe src="https://radarthing.com/radar?callsign=KLM,KL" class="absolute inset-0 w-full h-full border-0 mix-blend-screen opacity-90" allowfullscreen></iframe>
                    </div>
                </div>
            `,

            sop: `
                <div class="py-24 animate-fade-in">
                    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="text-center mb-16 animate-slide-up">
                            <h1 class="text-4xl font-black text-white mb-4">Standard Operating Procedures</h1>
                            <p class="text-slate-400 font-light max-w-2xl mx-auto">Discipline in the virtual skies. Adherence to these procedures separates casual flyers from elite pilots.</p>
                        </div>
                        <div class="space-y-6">
                            <div class="glass-panel p-8 rounded-3xl border-l-4 border-sky-500 animate-slide-up delay-100">
                                <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-3"><span class="bg-white/10 w-8 h-8 flex items-center justify-center rounded-full text-xs font-mono">01</span> Preparation</h3>
                                <p class="text-slate-400 font-light">SimBrief Flight Plan is strictly mandatory. Fuel planning must include accurate reserves. Doors closed 5-15 min prior to EOBT.</p>
                            </div>
                            <div class="glass-panel p-8 rounded-3xl border-l-4 border-klm animate-slide-up delay-200">
                                <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-3"><span class="bg-white/10 w-8 h-8 flex items-center justify-center rounded-full text-xs font-mono">02</span> Execution Parameters</h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center font-mono">
                                    <div class="bg-white/5 p-4 rounded-xl border border-white/5">
                                        <div class="text-slate-500 text-[10px] mb-1">TAXI SPEED</div>
                                        <div class="text-white font-bold text-lg">MAX 25KT</div>
                                    </div>
                                    <div class="bg-white/5 p-4 rounded-xl border border-white/5">
                                        <div class="text-slate-500 text-[10px] mb-1">&lt; 10,000 FT</div>
                                        <div class="text-white font-bold text-lg">250 KTS</div>
                                    </div>
                                    <div class="bg-white/5 p-4 rounded-xl border border-white/5">
                                        <div class="text-slate-500 text-[10px] mb-1">CRUISE</div>
                                        <div class="text-white font-bold text-lg">COST IDX</div>
                                    </div>
                                    <div class="bg-white/5 p-4 rounded-xl border border-white/5">
                                        <div class="text-slate-500 text-[10px] mb-1">RVSM SEP</div>
                                        <div class="text-white font-bold text-lg">1000 FT</div>
                                    </div>
                                </div>
                            </div>
                            <div class="glass-panel p-8 rounded-3xl border-l-4 border-emerald-500 animate-slide-up delay-300">
                                <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-3"><span class="bg-white/10 w-8 h-8 flex items-center justify-center rounded-full text-xs font-mono">03</span> Logging & Validation</h3>
                                <p class="text-slate-400 font-light">Upon arrival, submit logs to the designated Discord channel including: Dep/Arr ICAO, Block Time, Callsign, and a verification screenshot.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `,

            partners: `
                <div class="py-24 animate-fade-in">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        
                        <!-- LUFTHANSA CARD -->
                        <div class="glass-panel rounded-3xl p-8 md:p-12 mb-12 border border-white/10 relative overflow-hidden animate-slide-up group">
                             <div class="absolute inset-0 bg-gradient-to-r from-amber-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-700 pointer-events-none"></div>
                             <div class="relative z-10 flex flex-col md:flex-row gap-12 items-center">
                                <div class="md:w-1/2">
                                    <div class="text-amber-500 text-[10px] font-bold uppercase tracking-[0.3em] mb-4">Parent Airline Group</div>
                                    <h2 class="text-4xl md:text-5xl font-black text-white mb-4">Lufthansa Group (DLH)</h2>
                                    <p class="text-slate-400 font-light text-lg leading-relaxed mb-8">
                                        DLH holds a strategic stake, ensuring backend operational stability while KLM VA operates independently as an active, elite simulation tier.
                                    </p>
                                    <div class="flex flex-wrap gap-4">
                                        <a href="https://midmm2tehdumb.github.io/Lufthansa-Group/index.html" target="_blank" class="px-6 py-3 bg-white/5 border border-white/10 hover:bg-white/10 text-white rounded-xl text-xs font-bold uppercase tracking-widest transition-colors">Visit Hub</a>
                                        <a href="https://discord.gg/TJRUPZj3t9" target="_blank" class="px-6 py-3 bg-amber-500 hover:bg-amber-400 text-slate-900 rounded-xl text-xs font-black uppercase tracking-widest transition-colors shadow-lg shadow-amber-500/20">DLH Discord</a>
                                    </div>
                                </div>
                                <div class="md:w-1/2 grid grid-cols-2 gap-4 w-full">
                                    <div class="bg-black/40 p-6 rounded-2xl border border-white/5 text-center">
                                        <i data-lucide="shield" class="w-8 h-8 text-amber-500 mx-auto mb-3"></i>
                                        <div class="text-2xl font-black text-white">Platinum</div>
                                        <div class="text-[9px] text-slate-500 uppercase tracking-widest mt-1">GASA Rating</div>
                                    </div>
                                    <div class="bg-black/40 p-6 rounded-2xl border border-white/5 text-center">
                                        <i data-lucide="globe" class="w-8 h-8 text-amber-500 mx-auto mb-3"></i>
                                        <div class="text-2xl font-black text-white">A+</div>
                                        <div class="text-[9px] text-slate-500 uppercase tracking-widest mt-1">ICAO Status</div>
                                    </div>
                                </div>
                             </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                             <div class="glass-panel p-8 rounded-3xl animate-slide-up delay-100 hover-lift">
                                <div class="w-12 h-12 rounded-full bg-klm/10 flex items-center justify-center mb-6 border border-klm/20">
                                    <i data-lucide="scale" class="text-klm w-5 h-5"></i>
                                </div>
                                <h4 class="text-xl font-bold text-white mb-3">GASA (Safety Authority)</h4>
                                <p class="text-sm text-slate-400 font-light leading-relaxed">Ensures safety, fairness, and realism across the network. Operating as a neutral global oversight body handling incident investigations and certification.</p>
                            </div>
                            <div class="glass-panel p-8 rounded-3xl animate-slide-up delay-200 hover-lift">
                                <div class="w-12 h-12 rounded-full bg-emerald-500/10 flex items-center justify-center mb-6 border border-emerald-500/20">
                                    <i data-lucide="network" class="text-emerald-500 w-5 h-5"></i>
                                </div>
                                <h4 class="text-xl font-bold text-white mb-3">ICAO Community</h4>
                                <p class="text-sm text-slate-400 font-light leading-relaxed mb-4">Prevents chaos and fragmentation in the virtual skies. Provides the shared framework for recognition and diplomatic relations.</p>
                                <div class="inline-block bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-widest">Certified Org</div>
                            </div>
                        </div>
                    </div>
                </div>
            `
        };


        // --- PROFILE / FIREBASE LOGIC ---
        async function initProfile() {
            if(!discordUser) {
                document.getElementById('profile-login-prompt')?.classList.remove('hidden');
                document.getElementById('profile-content')?.classList.add('hidden');
                return;
            }
            document.getElementById('profile-login-prompt')?.classList.add('hidden');
            document.getElementById('profile-content')?.classList.remove('hidden');

            document.getElementById('profile-avatar').src = `https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png`;
            document.getElementById('profile-name').textContent = discordUser.username;
            document.getElementById('profile-id').textContent = discordUser.id.substring(0, 8); // Just show a part of it

            if(!db) return;

            try {
                // Fetch bookings for this pilot
                const q = query(collection(db, "bookings"), where("pilot.discordId", "==", discordUser.id));
                const snapshot = await getDocs(q);
                
                // Sort client-side to avoid needing composite indexes on firebase
                const logs = [];
                snapshot.forEach(doc => logs.push(doc.data()));
                logs.sort((a,b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

                const totalBookings = logs.length;
                let completed = 0;
                let logbookHTML = '';

                logs.forEach((data, index) => {
                    if(data.status === 'LOGGED' || data.status === 'ARRIVED') completed++;
                    
                    if(index < 5) { // Show top 5 recent
                        let dateStr = '--/--';
                        if (data.scheduledDeparture) {
                            try { dateStr = new Date(data.scheduledDeparture).toLocaleDateString('en-GB', {day: '2-digit', month: 'short'}).toUpperCase(); } catch (e) {}
                        }
                        
                        let statusColor = 'text-slate-400';
                        if(data.status === 'LOGGED' || data.status === 'ARRIVED') statusColor = 'text-klm';
                        if(data.status === 'BOOKED') statusColor = 'text-emerald-400';

                        logbookHTML += `
                            <tr class="border-b border-white/5 hover:bg-white/5 transition-colors">
                                <td class="py-3 px-4 font-mono text-slate-400">${dateStr}</td>
                                <td class="py-3 px-4 font-bold text-white">${data.flightNumber || '---'}</td>
                                <td class="py-3 px-4 text-slate-300">${data.departure} ➝ ${data.destination}</td>
                                <td class="py-3 px-4 text-slate-400">${data.aircraft?.icao || '---'}</td>
                                <td class="py-3 px-4 text-right text-[10px] font-bold uppercase tracking-widest ${statusColor}">${data.status}</td>
                            </tr>
                        `;
                    }
                });

                document.getElementById('stat-booked').textContent = totalBookings;
                document.getElementById('stat-completed').textContent = completed;
                
                // Rank calculation
                let rank = "Trainee";
                let progress = (completed / 5) * 100;
                
                if(completed >= 5) { rank = "Junior Officer"; progress = ((completed-5) / 10) * 100; }
                if(completed >= 15) { rank = "First Officer"; progress = ((completed-15) / 35) * 100; }
                if(completed >= 50) { rank = "Captain"; progress = 100; }
                
                progress = Math.min(100, Math.max(0, progress)); // clamp 0-100
                
                document.getElementById('stat-rank').textContent = rank;
                setTimeout(() => {
                    const bar = document.getElementById('rank-progress');
                    if(bar) bar.style.width = `${progress}%`;
                }, 100);

                const tb = document.getElementById('profile-logbook-table');
                if(tb) {
                    if(logs.length === 0) tb.innerHTML = `<tr><td colspan="5" class="py-8 text-center text-slate-500">No flight records found in the database.</td></tr>`;
                    else tb.innerHTML = logbookHTML;
                }

            } catch (e) {
                console.error("Error fetching profile stats", e);
                const tb = document.getElementById('profile-logbook-table');
                if(tb) tb.innerHTML = `<tr><td colspan="5" class="py-8 text-center text-red-400">Database connection error.</td></tr>`;
            }
        }


        // --- CONDOLENCE LOGIC ---
        let condolenceUnsubscribe = null;
        window.submitCondolence = async () => {
            const btn = document.getElementById('condolence-btn');
            const btnText = document.getElementById('condolence-btn-text');
            if (localStorage.getItem('klm_condolence_submitted')) { alert("Thank you. You have already paid your respects."); return; }
            if (!db) return;
            btn.disabled = true;
            btnText.textContent = "Submitting...";
            try {
                const ref = doc(db, "site_stats", "condolences");
                try { await updateDoc(ref, { count: increment(1) }); } catch (e) { await setDoc(ref, { count: 1 }); }
                localStorage.setItem('klm_condolence_submitted', 'true');
                btnText.textContent = "Respects Paid";
            } catch (e) { console.error(e); btn.disabled = false; btnText.textContent = "Try Again"; }
        };

        function initCondolences() {
            if (!db) return;
            const ref = doc(db, "site_stats", "condolences");
            if (localStorage.getItem('klm_condolence_submitted')) {
                const btn = document.getElementById('condolence-btn');
                const btnText = document.getElementById('condolence-btn-text');
                if(btn && btnText) { btn.disabled = true; btnText.textContent = "Respects Paid"; }
            }
            condolenceUnsubscribe = onSnapshot(ref, (docSnap) => {
                const countEl = document.getElementById('condolence-count');
                if (countEl) countEl.textContent = docSnap.exists() ? docSnap.data().count.toLocaleString() : "0";
            });
        }

        // --- ROUTER LOGIC ---
        let dispatchUnsubscribe = null; 

        function router(pageName) {
            if (dispatchUnsubscribe) { dispatchUnsubscribe(); dispatchUnsubscribe = null; }
            if (condolenceUnsubscribe) { condolenceUnsubscribe(); condolenceUnsubscribe = null; }

            const contentDiv = document.getElementById('app-content');
            contentDiv.innerHTML = pages[pageName] || pages['home'];
            
            if (pageName === 'routes') { setTimeout(() => { initFleetMap(); renderRouteGrid('Europe'); }, 100); }
            if (pageName === 'booking') { setTimeout(initBookingPage, 100); }
            if (pageName === 'home') { setTimeout(initDispatchBoard, 500); }
            if (pageName === 'profile') { setTimeout(initProfile, 100); }
            if (pageName === 'condolences') { setTimeout(initCondolences, 100); }

            lucide.createIcons();
            window.scrollTo(0, 0);
            
            document.querySelectorAll('.nav-link').forEach(btn => {
                if(btn.getAttribute('onclick').includes(pageName)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        window.router = router;

        // --- BOOKING LOGIC ---
        let currentDirection = 'out';
        let bookingRouteList = [];

        function initBookingPage() {
            const regionSelect = document.getElementById('region-select');
            const acSelect = document.getElementById('aircraft-select');
            const loginSection = document.getElementById('login-section');
            const bookingFormBtn = document.querySelector('#booking-form button[type="submit"]');

            const regions = Object.keys(routeData);
            if(regionSelect) regionSelect.innerHTML = regions.map(r => `<option value="${r}">${r}</option>`).join('');
            if(acSelect) acSelect.innerHTML = fleetData.filter(f => f.status === 'Active' || f.status === 'Phasing Out' || f.status === 'LTRP').map(f => `<option value="${f.type}">${f.type}</option>`).join('');
            
            if(loginSection) {
                if(discordUser) {
                    if (discordUser.isMember) {
                        loginSection.innerHTML = `
                            <div class="flex items-center gap-4 bg-emerald-500/10 p-5 rounded-2xl border border-emerald-500/20">
                                 <img src="https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png" 
                                      class="w-14 h-14 rounded-full border-2 border-emerald-500 shadow-[0_0_15px_rgba(16,185,129,0.3)]">
                                 <div class="flex-grow">
                                    <div class="text-[10px] text-emerald-400 font-bold uppercase tracking-widest mb-1 flex items-center gap-1"><i data-lucide="check-circle" class="w-3 h-3"></i> Verified Access</div>
                                    <div class="text-xl font-black text-white">${discordUser.username}</div>
                                 </div>
                            </div>
                        `;
                        if(bookingFormBtn) { bookingFormBtn.disabled = false; }
                    } else {
                        const discordAuthUrl = "https://discord.com/oauth2/authorize?client_id=1464272995542634566&response_type=token&redirect_uri=https%3A%2F%2Fklmgeofsvirtual.github.io%2Fklm-virtual-airline%2F&scope=identify+guilds";
                         loginSection.innerHTML = `
                            <div class="bg-red-500/10 p-5 rounded-2xl border border-red-500/20 flex flex-col md:flex-row md:items-center gap-4">
                                <i data-lucide="alert-circle" class="w-8 h-8 text-red-500 shrink-0"></i>
                                <div>
                                    <h4 class="text-red-400 font-bold text-sm uppercase tracking-wider mb-1">Access Denied</h4>
                                    <p class="text-slate-400 text-xs font-light">Logged in as <strong>${discordUser.username}</strong>, but missing Server Verification.</p>
                                    <div class="flex gap-4 mt-3">
                                        <a href="https://discord.gg/vRzmhuEmBQ" target="_blank" class="text-[10px] font-bold text-white bg-white/10 px-3 py-1.5 rounded uppercase tracking-widest hover:bg-white/20 transition">1. Join</a>
                                        <button onclick="localStorage.removeItem('klm_discord_user'); window.location.href = '${discordAuthUrl}';" class="text-[10px] font-bold text-white bg-klm px-3 py-1.5 rounded uppercase tracking-widest hover:bg-sky-400 transition">2. Sync</button>
                                    </div>
                                </div>
                            </div>
                        `;
                        if(bookingFormBtn) { bookingFormBtn.disabled = true; }
                    }
                    lucide.createIcons();
                } else {
                    const discordAuthUrl = "https://discord.com/oauth2/authorize?client_id=1464272995542634566&response_type=token&redirect_uri=https%3A%2F%2Fklmgeofsvirtual.github.io%2Fklm-virtual-airline%2F&scope=identify+guilds";
                    loginSection.innerHTML = `
                        <a href="${discordAuthUrl}" class="flex items-center justify-center w-full bg-[#5865F2] hover:bg-[#4752C4] text-white font-black uppercase tracking-widest py-4 rounded-xl transition-all shadow-[0_0_20px_rgba(88,101,242,0.3)] hover:scale-[1.02]">
                            <svg class="w-5 h-5 mr-3 fill-current" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037 20.818 20.818 0 0 0-3.361 6.91 20.8 20.8 0 0 0-3.356-6.91.071.071 0 0 0-.077-.037 19.782 19.782 0 0 0-4.886 1.515.072.072 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.086 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.086 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>
                            Authenticate Profile
                        </a>
                    `;
                }
            }
            updateDestinations();
        }

        function setDirection(dir) {
            currentDirection = dir;
            const btnOut = document.getElementById('btn-out');
            const btnIn = document.getElementById('btn-in');
            if(dir === 'out') {
                btnOut.className = "flex-1 py-2 rounded-md font-bold text-xs uppercase tracking-wide bg-klm text-white shadow-lg transition-all";
                btnIn.className = "flex-1 py-2 rounded-md font-bold text-xs uppercase tracking-wide text-slate-500 hover:text-white transition-all";
            } else {
                btnOut.className = "flex-1 py-2 rounded-md font-bold text-xs uppercase tracking-wide text-slate-500 hover:text-white transition-all";
                btnIn.className = "flex-1 py-2 rounded-md font-bold text-xs uppercase tracking-wide bg-klm text-white shadow-lg transition-all";
            }
            updateFlightDetails();
        }
        window.setDirection = setDirection;

        function updateDestinations() {
            const region = document.getElementById('region-select').value;
            const destSelect = document.getElementById('dest-select');
            if(routeData[region]) {
                bookingRouteList = routeData[region];
                destSelect.innerHTML = bookingRouteList.map((route, index) => `<option value="${index}">${route.city} (${route.code})</option>`).join('');
                updateFlightDetails();
            }
        }
        window.updateDestinations = updateDestinations;
        
        window.toggleCustomRoute = () => {
            const isCustom = document.getElementById('custom-route-toggle').checked;
            if (isCustom) {
                document.getElementById('standard-controls').classList.add('hidden');
                document.getElementById('custom-controls').classList.remove('hidden');
            } else {
                document.getElementById('standard-controls').classList.remove('hidden');
                document.getElementById('custom-controls').classList.add('hidden');
            }
            window.updatePreview();
        };

        function updateFlightDetails() {
            const index = document.getElementById('dest-select').value;
            const flightSelect = document.getElementById('flight-select');
            const route = bookingRouteList[index];
            if (!route) return;
            if (currentDirection === 'out') {
                document.getElementById('disp-dep').textContent = "EHAM";
                document.getElementById('disp-arr').textContent = route.code;
            } else {
                document.getElementById('disp-dep').textContent = route.code;
                document.getElementById('disp-arr').textContent = "EHAM";
            }
            const numbers = (currentDirection === 'out' ? route.out : route.in).replace(/[+*]/g, '').split(',').map(s => s.trim()).filter(s => s);
            flightSelect.innerHTML = numbers.map(num => `<option value="${num}">${num}</option>`).join('');
            updatePreview();
        }
        window.updateFlightDetails = updateFlightDetails;

        function updatePreview() {
            const isCustom = document.getElementById('custom-route-toggle') ? document.getElementById('custom-route-toggle').checked : false;
            let callsign, dep, arr;

            if (isCustom) {
                callsign = document.getElementById('custom-flight').value || '---';
                dep = document.getElementById('custom-dep').value || '---';
                arr = document.getElementById('custom-arr').value || '---';
                document.getElementById('disp-dep').textContent = dep === '---' ? '----' : dep;
                document.getElementById('disp-arr').textContent = arr === '---' ? '----' : arr;
            } else {
                callsign = document.getElementById('flight-select').value || '---';
                dep = document.getElementById('disp-dep').textContent;
                arr = document.getElementById('disp-arr').textContent;
            }

            document.getElementById('preview-callsign').textContent = callsign;
            document.getElementById('preview-dep').textContent = dep;
            document.getElementById('preview-arr').textContent = arr;
            document.getElementById('preview-pilot').textContent = discordUser ? discordUser.username : '---';
            document.getElementById('preview-ac').textContent = document.getElementById('aircraft-select').value || '---';
            document.getElementById('preview-time').textContent = (document.getElementById('dep-time').value || '--:--') + 'z';
        }
        window.updatePreview = updatePreview;

        async function handleBookingSubmit(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            
            if (!discordUser || !discordUser.isMember) return;

            btn.innerHTML = `<i data-lucide="loader" class="w-5 h-5 mr-3 animate-spin"></i> TRANSMITTING...`;
            btn.disabled = true;

            const isCustom = document.getElementById('custom-route-toggle').checked;
            let flightNumber, departure, destination;
            
            if (isCustom) {
                flightNumber = document.getElementById('custom-flight').value.toUpperCase();
                departure = document.getElementById('custom-dep').value.toUpperCase();
                destination = document.getElementById('custom-arr').value.toUpperCase();
                if (departure.length !== 4 || destination.length !== 4) {
                    alert("Valid 4-letter ICAO codes required.");
                    btn.innerHTML = originalText; btn.disabled = false; return;
                }
            } else {
                flightNumber = document.getElementById('flight-select').value;
                destination = document.getElementById('disp-arr').textContent;
                departure = document.getElementById('disp-dep').textContent;
            }
            
            const selectedFleet = fleetData.find(f => f.type === document.getElementById('aircraft-select').value);
            const timeVal = document.getElementById('dep-time').value;
            const today = new Date();
            const [hours, minutes] = timeVal.split(':');
            today.setHours(hours, minutes, 0, 0);

            if (!db) { alert("Database offline."); btn.innerHTML = originalText; btn.disabled = false; return; }

            try {
                await addDoc(collection(db, "bookings"), {
                    flightNumber: flightNumber,
                    aircraft: { name: selectedFleet.type, icao: selectedFleet.icao },
                    departure: departure,
                    destination: destination,
                    pilot: { discordId: discordUser.id, callsign: discordUser.username, username: discordUser.username },
                    status: document.getElementById('is-test-flight').checked ? "TEST" : "BOOKED",
                    scheduledDeparture: today.toISOString(),
                    createdAt: serverTimestamp()
                });
                router('home');
            } catch (error) {
                console.error(error);
                document.getElementById('db-error-banner').classList.remove('hidden');
                btn.innerHTML = originalText; btn.disabled = false;
            }
        }
        window.handleBookingSubmit = handleBookingSubmit;

        // --- DISPATCH BOARD ---
        function initDispatchBoard() {
            const board = document.getElementById('dispatch-rows');
            if(!board || !db) return;
            const statusColors = { 'TEST': 'text-amber-500', 'LOGGED': 'text-slate-500', 'BOOKED': 'text-klm', 'DEPARTED': 'text-sky-400', 'ENROUTE': 'text-indigo-400', 'ARRIVED': 'text-emerald-400', 'CANCELED': 'text-red-500' };

            const q = query(collection(db, "bookings"), orderBy("createdAt", "desc"), limit(20));
            dispatchUnsubscribe = onSnapshot(q, (querySnapshot) => {
                const sl = document.getElementById('db-status-light');
                const st = document.getElementById('db-status-text');
                if (sl) { sl.classList.replace('bg-red-500', 'bg-emerald-500'); sl.classList.remove('animate-pulse'); st.textContent = "SECURE LINK ACTIVE"; }
                
                board.innerHTML = "";
                if(querySnapshot.empty) { board.innerHTML = '<div class="p-8 text-center text-slate-500">Awaiting dispatch orders.</div>'; return; }
                
                querySnapshot.forEach((doc) => {
                    const d = doc.data();
                    let dateStr = '--/--';
                    if (d.scheduledDeparture) try { dateStr = new Date(d.scheduledDeparture).toLocaleDateString('en-GB', {day: '2-digit', month: 'short'}).toUpperCase(); } catch (e) {}
                    
                    const row = document.createElement('div');
                    row.className = 'fids-row';
                    row.innerHTML = `
                        <div class="font-bold text-white truncate">${d.pilot?.callsign || 'Unknown'}</div>
                        <div class="text-slate-300">${d.flightNumber || '---'}</div>
                        <div class="text-slate-500">${dateStr}</div>
                        <div class="hidden md:block text-slate-300">${d.departure || '---'} ➝ ${d.destination || '---'}</div>
                        <div class="text-slate-400">${d.aircraft?.name || '---'}</div>
                        <div class="text-right font-bold uppercase tracking-widest ${statusColors[d.status || 'BOOKED']} text-[10px]">${d.status || 'BOOKED'}</div>
                    `;
                    board.appendChild(row);
                });
            }, (error) => {
                const sl = document.getElementById('db-status-light');
                if (sl) { sl.classList.replace('bg-emerald-500', 'bg-red-500'); sl.classList.add('animate-pulse'); document.getElementById('db-status-text').textContent = "LINK LOST"; }
            });
        }

        // --- MAP LOGIC ---
        let mapInstance = null, flightLinesLayer = null;
        const routeManifest = [
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "EGLL", "destinationCoords": [-0.4543, 51.4700] },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "LFPG", "destinationCoords": [2.5479, 49.0097] },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "KJFK", "destinationCoords": [-73.7781, 40.6413] },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "OMDB", "destinationCoords": [55.3644, 25.2532] },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "WSSS", "destinationCoords": [103.9940, 1.3644] },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "SBGR", "destinationCoords": [-46.4731, -23.4356] },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "FAOR", "destinationCoords": [28.2411, -26.1367] },
          { "origin": "EHAM", "originCoords": [4.7639, 52.3091], "destination": "RJAA", "destinationCoords": [140.3929, 35.7719] }
        ];

        function initFleetMap() {
            const container = document.getElementById('fleet-map');
            if (!container) return;
            if (mapInstance) { mapInstance.remove(); mapInstance = null; }
            mapInstance = L.map('fleet-map', { center: [30, 0], zoom: 2, minZoom: 2, maxBounds: [[-90, -180], [90, 180]], zoomControl: false, attributionControl: false });
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { subdomains: 'abcd', maxZoom: 19 }).addTo(mapInstance);
            flightLinesLayer = L.layerGroup().addTo(mapInstance);
            
            const hubIcon = L.divIcon({ className: 'custom-div-icon', html: "<div style='background-color:#00A1DE;width:8px;height:8px;border-radius:50%;box-shadow:0 0 20px #00A1DE;'></div>", iconSize: [8, 8], iconAnchor: [4, 4] });
            L.marker([52.3091, 4.7639], { icon: hubIcon }).addTo(flightLinesLayer);
            
            routeManifest.forEach(route => {
                const start = [route.originCoords[1], route.originCoords[0]];
                const end = [route.destinationCoords[1], route.destinationCoords[0]];
                const latlngs = getCurvePoints(start, end);
                L.polyline(latlngs, { color: '#00A1DE', weight: 1.5, opacity: 0.3 }).addTo(flightLinesLayer);
                L.circleMarker(end, { radius: 2, fillColor: '#fff', color: '#00A1DE', weight: 0, opacity: 1 }).addTo(flightLinesLayer);
            });
        }

        function getCurvePoints(start, end) {
            const lat1 = start[0], lng1 = start[1], lat2 = end[0], lng2 = end[1];
            const midLat = (lat1 + lat2) / 2, midLng = (lng1 + lng2) / 2;
            const dist = Math.sqrt(Math.pow(lat2 - lat1, 2) + Math.pow(lng2 - lng1, 2));
            const controlLat = midLat + (dist * 0.25), controlLng = midLng; 
            const points = [];
            for(let t=0; t<=1; t+=0.02) {
                const invT = 1 - t;
                points.push([ (invT * invT * lat1) + (2 * invT * t * controlLat) + (t * t * lat2), (invT * invT * lng1) + (2 * invT * t * controlLng) + (t * t * lng2) ]);
            }
            points.push([lat2, lng2]); 
            return points;
        }

        function renderRouteGrid(region) {
            const grid = document.getElementById('route-grid');
            const data = routeData[region] || [];
            document.querySelectorAll('.route-btn').forEach(btn => {
                if(btn.id === `btn-${region}`) { btn.classList.add('bg-klm', 'text-white'); btn.classList.remove('bg-white/5', 'text-slate-400'); }
                else { btn.classList.remove('bg-klm', 'text-white'); btn.classList.add('bg-white/5', 'text-slate-400'); }
            });
            grid.innerHTML = data.map(route => `
                <div class="glass-panel p-5 rounded-2xl hover-lift border-l-2 border-l-transparent hover:border-l-klm transition-all">
                    <div class="flex justify-between items-center mb-3">
                        <span class="font-bold text-white text-sm truncate">${route.city}</span>
                        <span class="font-mono text-xs text-klm bg-klm/10 px-2 rounded">${route.code}</span>
                    </div>
                    <div class="flex flex-col gap-1.5 text-[10px] font-mono text-slate-400">
                         <div class="bg-white/5 px-2 py-1 rounded truncate"><span class="text-slate-500 mr-1">OUT</span> ${route.out}</div>
                         <div class="bg-white/5 px-2 py-1 rounded truncate"><span class="text-slate-500 mr-1">IN</span> ${route.in}</div>
                    </div>
                </div>
            `).join('');
        }
        window.renderRouteGrid = renderRouteGrid;

        function toggleMobileMenu() { document.getElementById('mobile-menu').classList.toggle('hidden'); }
        window.toggleMobileMenu = toggleMobileMenu;

        document.getElementById('nav-logo').src = siteImages.logo;
        router('home');
    </script>
</body>
</html>
